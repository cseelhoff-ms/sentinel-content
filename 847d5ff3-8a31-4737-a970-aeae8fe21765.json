{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/847d5ff3-8a31-4737-a970-aeae8fe21765')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/847d5ff3-8a31-4737-a970-aeae8fe21765')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Potential Tampering With Security Products Via WMIC",
                "description": "Detects uninstallation or termination of security products using the WMIC utility\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_wmic_uninstall_security_products.yml\nAuthor: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)\nDate Modified: 2023-02-14\nStatus: test\nReferences: https://twitter.com/cglyer/status/1355171195654709249, https://thedfirreport.com/2021/10/18/icedid-to-xinglocker-ransomware-in-24-hours/, https://www.mandiant.com/resources/unc2165-shifts-to-evade-sanctions, https://research.nccgroup.com/2022/08/19/back-in-black-unlocking-a-lockbit-3-0-ransomware-attack/, https://www.trendmicro.com/en_us/research/23/a/vice-society-ransomware-group-targets-manufacturing-companies.html\nFalse Positives: Legitimate administration",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"wmic\" and TargetProcessCommandLine contains \"product where \" and TargetProcessCommandLine contains \"call\" and TargetProcessCommandLine contains \"uninstall\" and TargetProcessCommandLine contains \"/nointeractive\") or ((TargetProcessCommandLine contains \"wmic\" and TargetProcessCommandLine contains \"caption like \") and (TargetProcessCommandLine contains \"call delete\" or TargetProcessCommandLine contains \"call terminate\")) or (TargetProcessCommandLine contains \"process \" and TargetProcessCommandLine contains \"where \" and TargetProcessCommandLine contains \"delete\")) and (TargetProcessCommandLine contains \"%carbon%\" or TargetProcessCommandLine contains \"%cylance%\" or TargetProcessCommandLine contains \"%endpoint%\" or TargetProcessCommandLine contains \"%eset%\" or TargetProcessCommandLine contains \"%malware%\" or TargetProcessCommandLine contains \"%Sophos%\" or TargetProcessCommandLine contains \"%symantec%\" or TargetProcessCommandLine contains \"Antivirus\" or TargetProcessCommandLine contains \"AVG \" or TargetProcessCommandLine contains \"Carbon Black\" or TargetProcessCommandLine contains \"CarbonBlack\" or TargetProcessCommandLine contains \"Cb Defense Sensor 64-bit\" or TargetProcessCommandLine contains \"Crowdstrike Sensor\" or TargetProcessCommandLine contains \"Cylance \" or TargetProcessCommandLine contains \"Dell Threat Defense\" or TargetProcessCommandLine contains \"DLP Endpoint\" or TargetProcessCommandLine contains \"Endpoint Detection\" or TargetProcessCommandLine contains \"Endpoint Protection\" or TargetProcessCommandLine contains \"Endpoint Security\" or TargetProcessCommandLine contains \"Endpoint Sensor\" or TargetProcessCommandLine contains \"ESET File Security\" or TargetProcessCommandLine contains \"LogRhythm System Monitor Service\" or TargetProcessCommandLine contains \"Malwarebytes\" or TargetProcessCommandLine contains \"McAfee Agent\" or TargetProcessCommandLine contains \"Microsoft Security Client\" or TargetProcessCommandLine contains \"Sophos Anti-Virus\" or TargetProcessCommandLine contains \"Sophos AutoUpdate\" or TargetProcessCommandLine contains \"Sophos Credential Store\" or TargetProcessCommandLine contains \"Sophos Management Console\" or TargetProcessCommandLine contains \"Sophos Management Database\" or TargetProcessCommandLine contains \"Sophos Management Server\" or TargetProcessCommandLine contains \"Sophos Remote Management System\" or TargetProcessCommandLine contains \"Sophos Update Manager\" or TargetProcessCommandLine contains \"Threat Protection\" or TargetProcessCommandLine contains \"VirusScan\" or TargetProcessCommandLine contains \"Webroot SecureAnywhere\" or TargetProcessCommandLine contains \"Windows Defender\"))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion"],
                "techniques": ["T1562"],
                "alertRuleTemplateName": "847d5ff3-8a31-4737-a970-aeae8fe21765",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}