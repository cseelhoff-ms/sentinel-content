{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/38646daa-e78f-4ace-9de0-55547b2d30da')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/38646daa-e78f-4ace-9de0-55547b2d30da')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "PUA - Seatbelt Execution",
                "description": "Detects the execution of the PUA/Recon tool Seatbelt via PE information of command line parameters\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_pua_seatbelt.yml\nAuthor: Nasreddine Bencherchali (Nextron Systems)\nDate Modified: 2023-02-04\nStatus: experimental\nReferences: https://github.com/GhostPack/Seatbelt, https://www.bluetangle.dev/2022/08/fastening-seatbelt-on-threat-hunting.html\nFalse Positives: Unlikely",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\Seatbelt.exe\" or TargetProcessFilename =~ \"Seatbelt.exe\" or TargetProcessFileDescription =~ \"Seatbelt\" or (TargetProcessCommandLine contains \" DpapiMasterKeys\" or TargetProcessCommandLine contains \" InterestingProcesses\" or TargetProcessCommandLine contains \" InterestingFiles\" or TargetProcessCommandLine contains \" CertificateThumbprints\" or TargetProcessCommandLine contains \" ChromiumBookmarks\" or TargetProcessCommandLine contains \" ChromiumHistory\" or TargetProcessCommandLine contains \" ChromiumPresence\" or TargetProcessCommandLine contains \" CloudCredentials\" or TargetProcessCommandLine contains \" CredEnum\" or TargetProcessCommandLine contains \" CredGuard\" or TargetProcessCommandLine contains \" FirefoxHistory\" or TargetProcessCommandLine contains \" ProcessCreationEvents\")) or ((TargetProcessCommandLine contains \" -group=misc\" or TargetProcessCommandLine contains \" -group=remote\" or TargetProcessCommandLine contains \" -group=chromium\" or TargetProcessCommandLine contains \" -group=slack\" or TargetProcessCommandLine contains \" -group=system\" or TargetProcessCommandLine contains \" -group=user\" or TargetProcessCommandLine contains \" -group=all\") and TargetProcessCommandLine contains \" -outputfile=\"))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Discovery"],
                "techniques": ["T1087", "T1083", "T1526"],
                "alertRuleTemplateName": "38646daa-e78f-4ace-9de0-55547b2d30da",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}