{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/1ec65a5f-9473-4f12-97da-622044d6df21')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/1ec65a5f-9473-4f12-97da-622044d6df21')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Powershell Defender Disable Scan Feature",
                "description": "Detects requests to disable Microsoft Defender features using PowerShell commands\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_powershell_defender_disable_feature.yml\nAuthor: Florian Roth (Nextron Systems)\nDate Modified: 2022-03-07\nStatus: test\nReferences: https://docs.microsoft.com/en-us/powershell/module/defender/set-mppreference?view=windowsserver2022-ps, https://www.virustotal.com/gui/file/d609799091731d83d75ec5d1f030571af20c45efeeb94840b67ea09a3283ab65/behavior/C2AE, https://www.virustotal.com/gui/search/content%253A%2522Set-MpPreference%2520-Disable%2522/files\nFalse Positives: Possible Admin Activity, Other Cmdlets that may use the same parameters",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where TargetProcessCommandLine contains \"RGlzYWJsZVJlYWx0aW1lTW9uaXRvcmluZy\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVSZWFsdGltZU1vbml0b3Jpbmcg\"\n| where TargetProcessCommandLine contains \"EaXNhYmxlUmVhbHRpbWVNb25pdG9yaW5nI\"\n| where TargetProcessCommandLine contains \"RGlzYWJsZUlPQVZQcm90ZWN0aW9uI\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVJT0FWUHJvdGVjdGlvbi\"\n| where TargetProcessCommandLine contains \"EaXNhYmxlSU9BVlByb3RlY3Rpb24g\"\n| where TargetProcessCommandLine contains \"RGlzYWJsZUJlaGF2aW9yTW9uaXRvcmluZy\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVCZWhhdmlvck1vbml0b3Jpbmcg\"\n| where TargetProcessCommandLine contains \"EaXNhYmxlQmVoYXZpb3JNb25pdG9yaW5nI\"\n| where TargetProcessCommandLine contains \"RGlzYWJsZUJsb2NrQXRGaXJzdFNlZW4g\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVCbG9ja0F0Rmlyc3RTZWVuI\"\n| where TargetProcessCommandLine contains \"EaXNhYmxlQmxvY2tBdEZpcnN0U2Vlbi\"\n| where TargetProcessCommandLine contains \"ZGlzYWJsZXJlYWx0aW1lbW9uaXRvcmluZy\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVyZWFsdGltZW1vbml0b3Jpbmcg\"\n| where TargetProcessCommandLine contains \"kaXNhYmxlcmVhbHRpbWVtb25pdG9yaW5nI\"\n| where TargetProcessCommandLine contains \"ZGlzYWJsZWlvYXZwcm90ZWN0aW9uI\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVpb2F2cHJvdGVjdGlvbi\"\n| where TargetProcessCommandLine contains \"kaXNhYmxlaW9hdnByb3RlY3Rpb24g\"\n| where TargetProcessCommandLine contains \"ZGlzYWJsZWJlaGF2aW9ybW9uaXRvcmluZy\"\n| where TargetProcessCommandLine contains \"Rpc2FibGViZWhhdmlvcm1vbml0b3Jpbmcg\"\n| where TargetProcessCommandLine contains \"kaXNhYmxlYmVoYXZpb3Jtb25pdG9yaW5nI\"\n| where TargetProcessCommandLine contains \"ZGlzYWJsZWJsb2NrYXRmaXJzdHNlZW4g\"\n| where TargetProcessCommandLine contains \"Rpc2FibGVibG9ja2F0Zmlyc3RzZWVuI\"\n| where TargetProcessCommandLine contains \"kaXNhYmxlYmxvY2thdGZpcnN0c2Vlbi\"\n| where (((TargetProcessCommandLine contains \"Add-MpPreference \" or TargetProcessCommandLine contains \"Set-MpPreference \") and (TargetProcessCommandLine contains \"DisableRealtimeMonitoring \" or TargetProcessCommandLine contains \"DisableIOAVProtection \" or TargetProcessCommandLine contains \"DisableBehaviorMonitoring \" or TargetProcessCommandLine contains \"DisableBlockAtFirstSeen \") and (TargetProcessCommandLine contains \"$true\" or TargetProcessCommandLine contains \" 1 \")) or (( or  or  or  or  or  or  or ) and (TargetProcessCommandLine contains \"RABpAHMAYQBiAGwAZQBSAGUAYQBsAHQAaQBtAGUATQBvAG4AaQB0AG8AcgBpAG4AZwAgA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAUgBlAGEAbAB0AGkAbQBlAE0AbwBuAGkAdABvAHIAaQBuAGcAIA\" or TargetProcessCommandLine contains \"EAGkAcwBhAGIAbABlAFIAZQBhAGwAdABpAG0AZQBNAG8AbgBpAHQAbwByAGkAbgBnACAA\" or TargetProcessCommandLine contains \"RABpAHMAYQBiAGwAZQBJAE8AQQBWAFAAcgBvAHQAZQBjAHQAaQBvAG4AIA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUASQBPAEEAVgBQAHIAbwB0AGUAYwB0AGkAbwBuACAA\" or TargetProcessCommandLine contains \"EAGkAcwBhAGIAbABlAEkATwBBAFYAUAByAG8AdABlAGMAdABpAG8AbgAgA\" or TargetProcessCommandLine contains \"RABpAHMAYQBiAGwAZQBCAGUAaABhAHYAaQBvAHIATQBvAG4AaQB0AG8AcgBpAG4AZwAgA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAQgBlAGgAYQB2AGkAbwByAE0AbwBuAGkAdABvAHIAaQBuAGcAIA\" or TargetProcessCommandLine contains \"EAGkAcwBhAGIAbABlAEIAZQBoAGEAdgBpAG8AcgBNAG8AbgBpAHQAbwByAGkAbgBnACAA\" or TargetProcessCommandLine contains \"RABpAHMAYQBiAGwAZQBCAGwAbwBjAGsAQQB0AEYAaQByAHMAdABTAGUAZQBuACAA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAQgBsAG8AYwBrAEEAdABGAGkAcgBzAHQAUwBlAGUAbgAgA\" or TargetProcessCommandLine contains \"EAGkAcwBhAGIAbABlAEIAbABvAGMAawBBAHQARgBpAHIAcwB0AFMAZQBlAG4AIA\" or TargetProcessCommandLine contains \"ZABpAHMAYQBiAGwAZQByAGUAYQBsAHQAaQBtAGUAbQBvAG4AaQB0AG8AcgBpAG4AZwAgA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAcgBlAGEAbAB0AGkAbQBlAG0AbwBuAGkAdABvAHIAaQBuAGcAIA\" or TargetProcessCommandLine contains \"kAGkAcwBhAGIAbABlAHIAZQBhAGwAdABpAG0AZQBtAG8AbgBpAHQAbwByAGkAbgBnACAA\" or TargetProcessCommandLine contains \"ZABpAHMAYQBiAGwAZQBpAG8AYQB2AHAAcgBvAHQAZQBjAHQAaQBvAG4AIA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAaQBvAGEAdgBwAHIAbwB0AGUAYwB0AGkAbwBuACAA\" or TargetProcessCommandLine contains \"kAGkAcwBhAGIAbABlAGkAbwBhAHYAcAByAG8AdABlAGMAdABpAG8AbgAgA\" or TargetProcessCommandLine contains \"ZABpAHMAYQBiAGwAZQBiAGUAaABhAHYAaQBvAHIAbQBvAG4AaQB0AG8AcgBpAG4AZwAgA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAYgBlAGgAYQB2AGkAbwByAG0AbwBuAGkAdABvAHIAaQBuAGcAIA\" or TargetProcessCommandLine contains \"kAGkAcwBhAGIAbABlAGIAZQBoAGEAdgBpAG8AcgBtAG8AbgBpAHQAbwByAGkAbgBnACAA\" or TargetProcessCommandLine contains \"ZABpAHMAYQBiAGwAZQBiAGwAbwBjAGsAYQB0AGYAaQByAHMAdABzAGUAZQBuACAA\" or TargetProcessCommandLine contains \"QAaQBzAGEAYgBsAGUAYgBsAG8AYwBrAGEAdABmAGkAcgBzAHQAcwBlAGUAbgAgA\" or TargetProcessCommandLine contains \"kAGkAcwBhAGIAbABlAGIAbABvAGMAawBhAHQAZgBpAHIAcwB0AHMAZQBlAG4AIA\")))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion"],
                "techniques": ["T1562"],
                "alertRuleTemplateName": "1ec65a5f-9473-4f12-97da-622044d6df21",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}