{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-5160-5160-5160-5163A5163A115')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-5160-5160-5160-5163A5163A115')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation medium 15",
                "description": "Sigma Windows Process Creation low 15",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\cmd\\.exe\" and TargetProcessCommandLine contains \"copy \") or ((TargetProcessName endswith \"\\\\powershell\\.exe\" or TargetProcessName endswith \"\\\\pwsh\\.exe\") and (TargetProcessCommandLine contains \"copy-item\" or TargetProcessCommandLine contains \" copy \" or TargetProcessCommandLine contains \"cpi \" or TargetProcessCommandLine contains \" cp \")) or ((TargetProcessName endswith \"\\\\robocopy\\.exe\" or TargetProcessName endswith \"\\\\xcopy\\.exe\") or (TargetProcessFilename =~ \"robocopy\\.exe\" or TargetProcessFilename =~ \"XCOPY\\.EXE\"))) and (TargetProcessCommandLine contains \"\\\\System32\" or TargetProcessCommandLine contains \"\\\\SysWOW64\" or TargetProcessCommandLine contains \"\\\\WinSxS\"))|extend RuleId=\"5163A000-5160-5160-5160-5163A5163A114\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_copy_system_dir.yml\";\nlet q1=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\cmd\\.exe\" or TargetProcessName endswith \"\\\\powershell\\.exe\" or TargetProcessName endswith \"\\\\pwsh\\.exe\") or (TargetProcessFilename =~ \"Cmd\\.Exe\" or TargetProcessFilename =~ \"PowerShell\\.EXE\" or TargetProcessFilename =~ \"pwsh\\.dll\")) and ((ActingProcessName contains \"\\\\Windows\\\\Installer\\\\\" and ActingProcessName contains \"msi\") and ActingProcessName endswith \"tmp\"))|extend RuleId=\"1e53dd56-8d83-4eb4-a43e-b790a05510aa\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_elavated_msi_spawned_shell.yml\";\nlet q2=_Im_ProcessCreate\n| where ((ActingProcessName endswith \"\\\\chrome\\.exe\" or ActingProcessName endswith \"\\\\discord\\.exe\" or ActingProcessName endswith \"\\\\GitHubDesktop\\.exe\" or ActingProcessName endswith \"\\\\keybase\\.exe\" or ActingProcessName endswith \"\\\\msedge\\.exe\" or ActingProcessName endswith \"\\\\msedgewebview2\\.exe\" or ActingProcessName endswith \"\\\\msteams\\.exe\" or ActingProcessName endswith \"\\\\slack\\.exe\" or ActingProcessName endswith \"\\\\Teams\\.exe\") and ((TargetProcessName endswith \"\\\\cmd\\.exe\" or TargetProcessName endswith \"\\\\cscript\\.exe\" or TargetProcessName endswith \"\\\\mshta\\.exe\" or TargetProcessName endswith \"\\\\powershell\\.exe\" or TargetProcessName endswith \"\\\\pwsh\\.exe\" or TargetProcessName endswith \"\\\\regsvr32\\.exe\" or TargetProcessName endswith \"\\\\wscript\\.exe\") or (TargetProcessName contains \"\\\\AppData\\\\Local\\\\Temp\\\\\" or TargetProcessName contains \"\\\\Users\\\\Public\\\\\" or TargetProcessName contains \"\\\\Windows\\\\Temp\\\\\" or TargetProcessName contains \":\\\\Temp\\\\\")) and (not(((ActingProcessName endswith \"\\\\chrome\\.exe\" and TargetProcessName endswith \"\\\\chrome\\.exe\") or (ActingProcessName endswith \"\\\\discord\\.exe\" and TargetProcessName endswith \"\\\\discord\\.exe\") or (ActingProcessName endswith \"\\\\GitHubDesktop\\.exe\" and TargetProcessName endswith \"\\\\GitHubDesktop\\.exe\") or (ActingProcessName endswith \"\\\\keybase\\.exe\" and TargetProcessName endswith \"\\\\keybase\\.exe\") or (ActingProcessName endswith \"\\\\msedge\\.exe\" and TargetProcessName endswith \"\\\\msedge\\.exe\") or (ActingProcessName endswith \"\\\\msedgewebview2\\.exe\" and TargetProcessName endswith \"\\\\msedgewebview2\\.exe\") or (ActingProcessName endswith \"\\\\msteams\\.exe\" and TargetProcessName endswith \"\\\\msteams\\.exe\") or (ActingProcessName endswith \"\\\\slack\\.exe\" and TargetProcessName endswith \"\\\\slack\\.exe\") or (ActingProcessName endswith \"\\\\teams\\.exe\" and TargetProcessName endswith \"\\\\teams\\.exe\") or (TargetProcessName =~ \"C:\\\\Windows\\\\SysWOW64\\\\WerFault\\.exe\" or TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\WerFault\\.exe\")))) and (not((ActingProcessName endswith \"\\\\Discord\\.exe\" and TargetProcessCommandLine contains \"\\\\NVSMI\\\\nvidia-smi\\.exe\"))))|extend RuleId=\"f26eb764-fd89-464b-85e2-dc4a8e6e77b8\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_electron_app_children.yml\";\nlet q3=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\chrome\\.exe\" or TargetProcessName endswith \"\\\\code\\.exe\" or TargetProcessName endswith \"\\\\discord\\.exe\" or TargetProcessName endswith \"\\\\GitHubDesktop\\.exe\" or TargetProcessName endswith \"\\\\keybase\\.exe\" or TargetProcessName endswith \"\\\\msedge\\.exe\" or TargetProcessName endswith \"\\\\msedgewebview2\\.exe\" or TargetProcessName endswith \"\\\\msteams\\.exe\" or TargetProcessName endswith \"\\\\slack\\.exe\" or TargetProcessName endswith \"\\\\Teams\\.exe\") and (TargetProcessCommandLine contains \"--browser-subprocess-path\" or TargetProcessCommandLine contains \"--gpu-launcher\" or TargetProcessCommandLine contains \"--renderer-cmd-prefix\" or TargetProcessCommandLine contains \"--utility-cmd-prefix\"))|extend RuleId=\"378a05d8-963c-46c9-bcce-13c7657eac99\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_electron_exeuction_proxy.yml\";\nlet q4=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershell\\.exe\" or TargetProcessName endswith \"\\\\pwsh\\.exe\" or TargetProcessName endswith \"\\\\cmd\\.exe\") or (TargetProcessFilename =~ \"PowerShell\\.EXE\" or TargetProcessFilename =~ \"pwsh\\.dll\" or TargetProcessFilename =~ \"Cmd\\.Exe\")) and ((TargetUsername contains \"AUTHORI\" or TargetUsername contains \"AUTORI\") and LogonId =~ \"0x3e7\")) and (not((((ActingProcessName contains \":\\\\Windows\\\\System32\\\\\" or ActingProcessName contains \":\\\\Program Files (x86)\\\\\" or ActingProcessName contains \":\\\\Program Files\\\\\") and (TargetProcessName endswith \"\\\\cmd\\.exe\" or TargetProcessName endswith \"\\\\powershell\\.exe\")) or ((ActingProcessName contains \":\\\\Windows\\\\System32\" or ActingProcessName contains \":\\\\Windows\\\\WinSxS\\\\\") and ActingProcessName endswith \"\\\\CompatTelRunner\\.exe\" and ActingProcessCommandLine contains \":\\\\Windows\\\\system32\\\\CompatTelRunner\\.exe -m:appraiser\\.dll -f:DoScheduledTelemetryRun\") or (ActingProcessName endswith \":\\\\Windows\\\\SysWOW64\\\\msiexec\\.exe\" and ActingProcessCommandLine contains \":\\\\Windows\\\\syswow64\\\\MsiExec\\.exe -Embedding\" and TargetProcessCommandLine contains \"\\\\RegisterMicrosoftUpdate\\.ps1\") or ((TargetProcessCommandLine startswith \"powershell\\.exe -ExecutionPolicy Restricted -Command  $res = 0; \" or TargetProcessCommandLine startswith \"powershell\\.exe -ExecutionPolicy Restricted -Command Write-Host \") and (TargetProcessCommandLine endswith \"Write-Host 'Final result:', $Res;\" or TargetProcessCommandLine endswith \"Write-Host \\\"Final result:\\\", $res\" or TargetProcessCommandLine endswith \"Write-Host 'Final result: 1';\")) or (TargetProcessName endswith \"\\\\cmd\\.exe\" and TargetProcessCommandLine contains \"/d /c C:\\\\Windows\\\\system32\\\\silcollector\\.cmd\") or (TargetProcessName endswith \"\\\\cmd\\.exe\" and (TargetProcessCommandLine endswith \"cmd\\.exe /c btool server list replication_port --no-log\" or TargetProcessCommandLine endswith \"cmd\\.exe /c btool server list general --no-log\")) or (TargetProcessName endswith \"\\\\cmd\\.exe\" and TargetProcessCommandLine contains \":\\\\Windows\\\\system32\\\\reg\\.exe query hklm\\\\software\\\\microsoft\\\\windows\\\\softwareinventorylogging /v collectionstate /reg:64\") or (TargetProcessName endswith \":\\\\Windows\\\\System32\\\\cmd\\.exe\" and TargetProcessCommandLine endswith \":\\\\Windows\\\\system32\\\\cmd\\.exe /c PAUSE\")))) and (not(((ActingProcessName endswith \":\\\\ManageEngine\\\\ADManager Plus\\\\pgsql\\\\bin\\\\postgres\\.exe\" and TargetProcessName endswith \"\\\\cmd\\.exe\") or (ActingProcessName contains \":\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\\" and ActingProcessName endswith \"\\\\CitrixReceiverUpdater\\.exe\" and TargetProcessName endswith \"\\\\cmd\\.exe\") or (TargetProcessCommandLine contains \":\\\\WINDOWS\\\\system32\\\\cmd\\.exe /c \\\"\" and TargetProcessCurrentDirectory contains \":\\\\WINDOWS\\\\Temp\\\\asgard2-agent\\\\\") or (ActingProcessName contains \":\\\\Windows\\\\Temp\" and ActingProcessName endswith \"\\\\invcol\\.exe\" and ActingProcessCommandLine contains \":\\\\ProgramData\\\\Dell\\\\UpdateService\\\\\" and TargetProcessName endswith \"\\\\cmd\\.exe\") or (ActingProcessName contains \":\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\\" and TargetProcessCommandLine contains \":\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\\") or TargetProcessCommandLine contains \":\\\\Windows\\\\system32\\\\cmd\\.exe\\\" /C copy \\\"C:\\\\ProgramData\\\\Avira\\\\SystemSpeedup\\\\Update\\\\avira_speedup_setup_update\\.exe\\\"\" or (ActingProcessName =~ \"\" and TargetProcessCommandLine contains \":\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\\") or (isnull(ActingProcessName) and TargetProcessCommandLine contains \":\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\\")))))|extend RuleId=\"178e615d-e666-498b-9630-9ed363038101\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_elevated_system_shell.yml\";\nlet q5=_Im_ProcessCreate\n| where (ActingProcessName =~ \"C:\\\\Windows\\\\explorer\\.exe\" and TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\cmd\\.exe\" and (TargetProcessCommandLine contains \"powershell\" and TargetProcessCommandLine contains \"\\.lnk\"))|extend RuleId=\"30e92f50-bb5a-4884-98b5-d20aa80f3d7a\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_embed_exe_lnk.yml\";\nlet q6=_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"\\\\AppData\\\\Roaming\\\\\" or TargetProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Temp\\\\\") and (TargetProcessCommandLine contains \"\\\\{\" and TargetProcessCommandLine contains \"}\\\\\")) and (not(((TargetProcessName contains \"\\\\{\" and TargetProcessName contains \"}\\\\\") or isnull(TargetProcessName) or TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\drvinst\\.exe\"))))|extend RuleId=\"90b63c33-2b97-4631-a011-ceb0f47b77c3\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_execution_from_guid_folder_names.yml\";\nlet q7=_Im_ProcessCreate\n| where ((TargetProcessName contains \"\\\\wwwroot\\\\\" or TargetProcessName contains \"\\\\wmpub\\\\\" or TargetProcessName contains \"\\\\htdocs\\\\\") and (not(((TargetProcessName contains \"bin\\\\\" or TargetProcessName contains \"\\\\Tools\\\\\" or TargetProcessName contains \"\\\\SMSComponent\\\\\") and ActingProcessName endswith \"\\\\services\\.exe\"))))|extend RuleId=\"35efb964-e6a5-47ad-bbcd-19661854018d\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_execution_path_webserver.yml\";\nlet q8=_Im_ProcessCreate\n| where (((TargetProcessFileDescription =~ \"?\" and FileVersion =~ \"?\") or (TargetProcessFileDescription =~ \"?\" and TargetProcessFileProduct =~ \"?\") or (TargetProcessFileDescription =~ \"?\" and TargetProcessFileCompany =~ \"?\")) and TargetProcessName contains \"\\\\Downloads\\\\\")|extend RuleId=\"9637e8a5-7131-4f7f-bdc7-2b05d8670c43\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_file_characteristics.yml\";\nlet q9=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\cacls\\.exe\" or TargetProcessName endswith \"\\\\icacls\\.exe\" or TargetProcessName endswith \"\\\\net\\.exe\" or TargetProcessName endswith \"\\\\net1\\.exe\") and (TargetProcessCommandLine contains \"/grant\" or TargetProcessCommandLine contains \"/setowner\" or TargetProcessCommandLine contains \"/inheritance:r\")) or (TargetProcessName endswith \"\\\\attrib\\.exe\" and TargetProcessCommandLine contains \"-r\") or TargetProcessName endswith \"\\\\takeown\\.exe\") and (not((TargetProcessCommandLine endswith \"ICACLS C:\\\\ProgramData\\\\dynatrace\\\\gateway\\\\config\\\\connectivity\\.history /reset\" or (TargetProcessCommandLine contains \"ICACLS C:\\\\ProgramData\\\\dynatrace\\\\gateway\\\\config\\\\config\\.properties /grant :r \" and TargetProcessCommandLine contains \"S-1-5-19:F\") or (TargetProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\" or ActingProcessName endswith \"\\\\Microsoft VS Code\\\\Code\\.exe\")))))|extend RuleId=\"37ae075c-271b-459b-8d7b-55ad5f993dd8\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_file_permission_modifications.yml\";\nlet q10=_Im_ProcessCreate\n| where TargetProcessCommandLine contains \"::$index_allocation\"|extend RuleId=\"0900463c-b33b-49a8-be1d-552a3b553dae\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_hidden_dir_index_allocation.yml\";\nlet q11=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"echo\" or TargetProcessCommandLine contains \"copy\" or TargetProcessCommandLine contains \"type\" or TargetProcessCommandLine contains \"file createnew\" or TargetProcessCommandLine contains \"cacls\") and TargetProcessCommandLine contains \"C:\\\\Windows\\\\Fonts\\\\\" and (TargetProcessCommandLine contains \"\\.sh\" or TargetProcessCommandLine contains \"\\.exe\" or TargetProcessCommandLine contains \"\\.dll\" or TargetProcessCommandLine contains \"\\.bin\" or TargetProcessCommandLine contains \"\\.bat\" or TargetProcessCommandLine contains \"\\.cmd\" or TargetProcessCommandLine contains \"\\.js\" or TargetProcessCommandLine contains \"\\.msh\" or TargetProcessCommandLine contains \"\\.reg\" or TargetProcessCommandLine contains \"\\.scr\" or TargetProcessCommandLine contains \"\\.ps\" or TargetProcessCommandLine contains \"\\.vb\" or TargetProcessCommandLine contains \"\\.jar\" or TargetProcessCommandLine contains \"\\.pl\" or TargetProcessCommandLine contains \"\\.inf\" or TargetProcessCommandLine contains \"\\.cpl\" or TargetProcessCommandLine contains \"\\.hta\" or TargetProcessCommandLine contains \"\\.msi\" or TargetProcessCommandLine contains \"\\.vbs\"))|extend RuleId=\"ae9b0bd7-8888-4606-b444-0ed7410cb728\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_hiding_malware_in_fonts_folder.yml\";\nunion q0, q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["PrivilegeEscalation", "DefenseEvasion", "Persistence", "Execution"],
                "techniques": ["T1027", "T1564", "T1505", "T1222", "T1548", "T1211", "T1036", "T1059"],
                "alertRuleTemplateName": "5163A000-5160-5160-5160-5163A5163A115",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}