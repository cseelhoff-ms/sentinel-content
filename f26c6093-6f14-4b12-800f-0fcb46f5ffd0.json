{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/f26c6093-6f14-4b12-800f-0fcb46f5ffd0')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/f26c6093-6f14-4b12-800f-0fcb46f5ffd0')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Malicious Base64 Encoded PowerShell Keywords in Command Lines",
                "description": "Detects base64 encoded strings used in hidden malicious PowerShell command lines\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_powershell_hidden_b64_cmd.yml\nAuthor: John Lambert (rule)\nDate Modified: 2023-01-05\nStatus: test\nReferences: http://www.leeholmes.com/blog/2017/09/21/searching-for-content-in-base-64-strings/\nFalse Positives: Unknown",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") or (TargetProcessFilename =~ \"PowerShell.EXE\" or TargetProcessFilename =~ \"pwsh.dll\")) and TargetProcessCommandLine contains \" hidden \" and (TargetProcessCommandLine contains \"AGkAdABzAGEAZABtAGkAbgAgAC8AdAByAGEAbgBzAGYAZQByA\" or TargetProcessCommandLine contains \"aXRzYWRtaW4gL3RyYW5zZmVy\" or TargetProcessCommandLine contains \"IAaQB0AHMAYQBkAG0AaQBuACAALwB0AHIAYQBuAHMAZgBlAHIA\" or TargetProcessCommandLine contains \"JpdHNhZG1pbiAvdHJhbnNmZX\" or TargetProcessCommandLine contains \"YgBpAHQAcwBhAGQAbQBpAG4AIAAvAHQAcgBhAG4AcwBmAGUAcg\" or TargetProcessCommandLine contains \"Yml0c2FkbWluIC90cmFuc2Zlc\" or TargetProcessCommandLine contains \"AGMAaAB1AG4AawBfAHMAaQB6AGUA\" or TargetProcessCommandLine contains \"JABjAGgAdQBuAGsAXwBzAGkAegBlA\" or TargetProcessCommandLine contains \"JGNodW5rX3Npem\" or TargetProcessCommandLine contains \"QAYwBoAHUAbgBrAF8AcwBpAHoAZQ\" or TargetProcessCommandLine contains \"RjaHVua19zaXpl\" or TargetProcessCommandLine contains \"Y2h1bmtfc2l6Z\" or TargetProcessCommandLine contains \"AE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4A\" or TargetProcessCommandLine contains \"kATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8Abg\" or TargetProcessCommandLine contains \"lPLkNvbXByZXNzaW9u\" or TargetProcessCommandLine contains \"SQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuA\" or TargetProcessCommandLine contains \"SU8uQ29tcHJlc3Npb2\" or TargetProcessCommandLine contains \"Ty5Db21wcmVzc2lvb\" or TargetProcessCommandLine contains \"AE8ALgBNAGUAbQBvAHIAeQBTAHQAcgBlAGEAbQ\" or TargetProcessCommandLine contains \"kATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtA\" or TargetProcessCommandLine contains \"lPLk1lbW9yeVN0cmVhb\" or TargetProcessCommandLine contains \"SQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0A\" or TargetProcessCommandLine contains \"SU8uTWVtb3J5U3RyZWFt\" or TargetProcessCommandLine contains \"Ty5NZW1vcnlTdHJlYW\" or TargetProcessCommandLine contains \"4ARwBlAHQAQwBoAHUAbgBrA\" or TargetProcessCommandLine contains \"5HZXRDaHVua\" or TargetProcessCommandLine contains \"AEcAZQB0AEMAaAB1AG4Aaw\" or TargetProcessCommandLine contains \"LgBHAGUAdABDAGgAdQBuAGsA\" or TargetProcessCommandLine contains \"LkdldENodW5r\" or TargetProcessCommandLine contains \"R2V0Q2h1bm\" or TargetProcessCommandLine contains \"AEgAUgBFAEEARABfAEkATgBGAE8ANgA0A\" or TargetProcessCommandLine contains \"QASABSAEUAQQBEAF8ASQBOAEYATwA2ADQA\" or TargetProcessCommandLine contains \"RIUkVBRF9JTkZPNj\" or TargetProcessCommandLine contains \"SFJFQURfSU5GTzY0\" or TargetProcessCommandLine contains \"VABIAFIARQBBAEQAXwBJAE4ARgBPADYANA\" or TargetProcessCommandLine contains \"VEhSRUFEX0lORk82N\" or TargetProcessCommandLine contains \"AHIAZQBhAHQAZQBSAGUAbQBvAHQAZQBUAGgAcgBlAGEAZA\" or TargetProcessCommandLine contains \"cmVhdGVSZW1vdGVUaHJlYW\" or TargetProcessCommandLine contains \"MAcgBlAGEAdABlAFIAZQBtAG8AdABlAFQAaAByAGUAYQBkA\" or TargetProcessCommandLine contains \"NyZWF0ZVJlbW90ZVRocmVhZ\" or TargetProcessCommandLine contains \"Q3JlYXRlUmVtb3RlVGhyZWFk\" or TargetProcessCommandLine contains \"QwByAGUAYQB0AGUAUgBlAG0AbwB0AGUAVABoAHIAZQBhAGQA\" or TargetProcessCommandLine contains \"0AZQBtAG0AbwB2AGUA\" or TargetProcessCommandLine contains \"1lbW1vdm\" or TargetProcessCommandLine contains \"AGUAbQBtAG8AdgBlA\" or TargetProcessCommandLine contains \"bQBlAG0AbQBvAHYAZQ\" or TargetProcessCommandLine contains \"bWVtbW92Z\" or TargetProcessCommandLine contains \"ZW1tb3Zl\"))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Execution"],
                "techniques": ["T1059"],
                "alertRuleTemplateName": "f26c6093-6f14-4b12-800f-0fcb46f5ffd0",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}