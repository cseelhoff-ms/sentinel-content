{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/811e0002-b13b-4a15-9d00-a613fce66e42')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/811e0002-b13b-4a15-9d00-a613fce66e42')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "PUA - Process Hacker Execution",
                "description": "Detects the execution of Process Hacker based on binary metadata information (Image, Hash, Imphash, etc). Process Hacker is a tool to view and manipulate processes, kernel options and other low level options. Threat actors regularly abuse it to manipulate system processes.\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_pua_process_hacker.yml\nAuthor: Florian Roth (Nextron Systems)\nDate Modified: 2023-05-08\nStatus: experimental\nReferences: https://processhacker.sourceforge.io/, https://www.crowdstrike.com/blog/falcon-overwatch-report-finds-increase-in-ecrime/\nFalse Positives: While sometimes 'Process Hacker is used by legitimate administrators, the execution of Process Hacker must be investigated and allowed on a case by case basis",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((TargetProcessName contains \"\\\\ProcessHacker_\" or TargetProcessName endswith \"\\\\ProcessHacker.exe\" or (TargetProcessFilename =~ \"ProcessHacker.exe\" or TargetProcessFilename =~ \"Process Hacker\") or TargetProcessFileDescription =~ \"Process Hacker\" or TargetProcessFileProduct =~ \"Process Hacker\") or (Hashes contains \"MD5=68F9B52895F4D34E74112F3129B3B00D\" or Hashes contains \"MD5=B365AF317AE730A67C936F21432B9C71\" or Hashes contains \"SHA1=A0BDFAC3CE1880B32FF9B696458327CE352E3B1D\" or Hashes contains \"SHA1=C5E2018BF7C0F314FED4FD7FE7E69FA2E648359E\" or Hashes contains \"SHA256=D4A0FE56316A2C45B9BA9AC1005363309A3EDC7ACF9E4DF64D326A0FF273E80F\" or Hashes contains \"SHA256=BD2C2CF0631D881ED382817AFCCE2B093F4E412FFB170A719E2762F250ABFEA4\" or Hashes contains \"IMPHASH=3695333C60DEDECDCAFF1590409AA462\" or Hashes contains \"IMPHASH=04DE0AD9C37EB7BD52043D2ECAC958DF\") or ((md5 =~ \"68f9b52895f4d34e74112f3129b3b00d\" or md5 =~ \"b365af317ae730a67c936f21432b9c71\") or (sha1 =~ \"c5e2018bf7c0f314fed4fd7fe7e69fa2e648359e\" or sha1 =~ \"a0bdfac3ce1880b32ff9b696458327ce352e3b1d\") or (sha256 =~ \"d4a0fe56316a2c45b9ba9ac1005363309a3edc7acf9e4df64d326a0ff273e80f\" or sha256 =~ \"bd2c2cf0631d881ed382817afcce2b093f4e412ffb170a719e2762f250abfea4\") or (TargetProcessIMPHASH =~ \"04de0ad9c37eb7bd52043d2ecac958df\" or TargetProcessIMPHASH =~ \"3695333c60dedecdcaff1590409aa462\")))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion", "PrivilegeEscalation", "Persistence", "Discovery"],
                "techniques": ["T1564", "T1543", "T1622"],
                "alertRuleTemplateName": "811e0002-b13b-4a15-9d00-a613fce66e42",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}