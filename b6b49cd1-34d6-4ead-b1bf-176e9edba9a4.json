{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/b6b49cd1-34d6-4ead-b1bf-176e9edba9a4')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/b6b49cd1-34d6-4ead-b1bf-176e9edba9a4')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Potential PowerShell Obfuscation Via Reversed Commands",
                "description": "Detects the presence of reversed PowerShell commands in the CommandLine. This is often used as a method of obfuscation by attackers\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_powershell_cmdline_reversed_strings.yml\nAuthor: Teymur Kheirkhabarov (idea), Vasiliy Burov (rule), oscd.community, Tim Shelton\nDate Modified: 2023-05-31\nStatus: test\nReferences: https://2019.offzone.moscow/ru/report/hunting-for-powershell-abuses/, https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=66\nFalse Positives: Unlikely",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") or (TargetProcessFilename =~ \"PowerShell.EXE\" or TargetProcessFilename =~ \"pwsh.dll\")) and (TargetProcessCommandLine contains \"hctac\" or TargetProcessCommandLine contains \"kaerb\" or TargetProcessCommandLine contains \"dnammoc\" or TargetProcessCommandLine contains \"ekovn\" or TargetProcessCommandLine contains \"eliFd\" or TargetProcessCommandLine contains \"rahc\" or TargetProcessCommandLine contains \"etirw\" or TargetProcessCommandLine contains \"golon\" or TargetProcessCommandLine contains \"tninon\" or TargetProcessCommandLine contains \"eddih\" or TargetProcessCommandLine contains \"tpircS\" or TargetProcessCommandLine contains \"ssecorp\" or TargetProcessCommandLine contains \"llehsrewop\" or TargetProcessCommandLine contains \"esnopser\" or TargetProcessCommandLine contains \"daolnwod\" or TargetProcessCommandLine contains \"tneilCbeW\" or TargetProcessCommandLine contains \"tneilc\" or TargetProcessCommandLine contains \"ptth\" or TargetProcessCommandLine contains \"elifotevas\" or TargetProcessCommandLine contains \"46esab\" or TargetProcessCommandLine contains \"htaPpmeTteG\" or TargetProcessCommandLine contains \"tcejbO\" or TargetProcessCommandLine contains \"maerts\" or TargetProcessCommandLine contains \"hcaerof\" or TargetProcessCommandLine contains \"retupmoc\")) and (not((TargetProcessCommandLine contains \" -EncodedCommand \" or TargetProcessCommandLine contains \" -enc \"))))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion", "Execution"],
                "techniques": ["T1059", "T1027"],
                "alertRuleTemplateName": "b6b49cd1-34d6-4ead-b1bf-176e9edba9a4",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}