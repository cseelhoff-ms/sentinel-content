{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-4c76-45a9-804d-dc3f355f2015')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-4c76-45a9-804d-dc3f355f2015')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 015",
                "description": "Sigma Windows Process Creation high 015",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \".DownloadString(\" or TargetProcessCommandLine contains \".DownloadFile(\" or TargetProcessCommandLine contains \"Invoke-WebRequest \" or TargetProcessCommandLine contains \"iwr \") and (TargetProcessCommandLine contains \";iex $\" or TargetProcessCommandLine contains \"| IEX\" or TargetProcessCommandLine contains \"|IEX \" or TargetProcessCommandLine contains \"I`E`X\" or TargetProcessCommandLine contains \"I`EX\" or TargetProcessCommandLine contains \"IE`X\" or TargetProcessCommandLine contains \"iex \" or TargetProcessCommandLine contains \"IEX (\" or TargetProcessCommandLine contains \"IEX(\" or TargetProcessCommandLine contains \"Invoke-Expression\"))|extend RuleId=\"85b0b087-eddf-4a2b-b033-d771fa2b9775\";\nlet q1=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") and (TargetProcessCommandLine contains \"Add-PSSnapin\" and TargetProcessCommandLine contains \"Get-Recipient\" and TargetProcessCommandLine contains \"-ExpandProperty\" and TargetProcessCommandLine contains \"EmailAddresses\" and TargetProcessCommandLine contains \"SmtpAddress\" and TargetProcessCommandLine contains \"-hidetableheaders\"))|extend RuleId=\"312d0384-401c-4b8b-abdf-685ffba9a332\";\nlet q2=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") or (TargetProcessFilename =~ \"PowerShell.Exe\" or TargetProcessFilename =~ \"pwsh.dll\")) and (TargetProcessCommandLine contains \" -e \" or TargetProcessCommandLine contains \" -en \" or TargetProcessCommandLine contains \" -enc \" or TargetProcessCommandLine contains \" -enco\") and (TargetProcessCommandLine contains \" JAB\" or TargetProcessCommandLine contains \" SUVYI\" or TargetProcessCommandLine contains \" SQBFAFgA\" or TargetProcessCommandLine contains \" aWV4I\" or TargetProcessCommandLine contains \" IAB\" or TargetProcessCommandLine contains \" PAA\" or TargetProcessCommandLine contains \" aQBlAHgA\")) and (not((ActingProcessName contains \"C:\\\\Packages\\\\Plugins\\\\Microsoft.GuestConfiguration.ConfigurationforWindows\\\\\" or ActingProcessName contains \"\\\\gc_worker.exe\"))))|extend RuleId=\"b9d9cc83-380b-4ba3-8d8f-60c0e7e2930c\";\nlet q3=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \"IAAtAGIAeABvAHIAIAAwAHgA\" or TargetProcessCommandLine contains \"AALQBiAHgAbwByACAAMAB4A\" or TargetProcessCommandLine contains \"gAC0AYgB4AG8AcgAgADAAeA\" or TargetProcessCommandLine contains \"AC4ASQBuAHYAbwBrAGUAKAApACAAfAAg\" or TargetProcessCommandLine contains \"AuAEkAbgB2AG8AawBlACgAKQAgAHwAI\" or TargetProcessCommandLine contains \"ALgBJAG4AdgBvAGsAZQAoACkAIAB8AC\" or TargetProcessCommandLine contains \"AHsAMQB9AHsAMAB9ACIAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADEAfQB7ADAAfQAiACAALQBmAC\" or TargetProcessCommandLine contains \"AewAxAH0AewAwAH0AIgAgAC0AZgAg\" or TargetProcessCommandLine contains \"AHsAMAB9AHsAMwB9ACIAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADAAfQB7ADMAfQAiACAALQBmAC\" or TargetProcessCommandLine contains \"AewAwAH0AewAzAH0AIgAgAC0AZgAg\" or TargetProcessCommandLine contains \"AHsAMgB9AHsAMAB9ACIAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADIAfQB7ADAAfQAiACAALQBmAC\" or TargetProcessCommandLine contains \"AewAyAH0AewAwAH0AIgAgAC0AZgAg\" or TargetProcessCommandLine contains \"AHsAMQB9AHsAMAB9ACcAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADEAfQB7ADAAfQAnACAALQBmAC\" or TargetProcessCommandLine contains \"AewAxAH0AewAwAH0AJwAgAC0AZgAg\" or TargetProcessCommandLine contains \"AHsAMAB9AHsAMwB9ACcAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADAAfQB7ADMAfQAnACAALQBmAC\" or TargetProcessCommandLine contains \"AewAwAH0AewAzAH0AJwAgAC0AZgAg\" or TargetProcessCommandLine contains \"AHsAMgB9AHsAMAB9ACcAIAAtAGYAI\" or TargetProcessCommandLine contains \"B7ADIAfQB7ADAAfQAnACAALQBmAC\" or TargetProcessCommandLine contains \"AewAyAH0AewAwAH0AJwAgAC0AZgAg\")|extend RuleId=\"8d01b53f-456f-48ee-90f6-bc28e67d4e35\";\nlet q4=_Im_ProcessCreate\n| where TargetProcessCommandLine contains \"::FromBase64String(\"|extend RuleId=\"e32d4572-9826-4738-b651-95fa63747e8a\";\nlet q5=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \"Get-Process lsas\" or TargetProcessCommandLine contains \"ps lsas\" or TargetProcessCommandLine contains \"gps lsas\")|extend RuleId=\"b2815d0d-7481-4bf0-9b6c-a4c48a94b349\";\nlet q6=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") or (TargetProcessFilename =~ \"PowerShell.EXE\" or TargetProcessFilename =~ \"pwsh.dll\")) and TargetProcessCommandLine contains \" hidden \" and (TargetProcessCommandLine contains \"AGkAdABzAGEAZABtAGkAbgAgAC8AdAByAGEAbgBzAGYAZQByA\" or TargetProcessCommandLine contains \"aXRzYWRtaW4gL3RyYW5zZmVy\" or TargetProcessCommandLine contains \"IAaQB0AHMAYQBkAG0AaQBuACAALwB0AHIAYQBuAHMAZgBlAHIA\" or TargetProcessCommandLine contains \"JpdHNhZG1pbiAvdHJhbnNmZX\" or TargetProcessCommandLine contains \"YgBpAHQAcwBhAGQAbQBpAG4AIAAvAHQAcgBhAG4AcwBmAGUAcg\" or TargetProcessCommandLine contains \"Yml0c2FkbWluIC90cmFuc2Zlc\" or TargetProcessCommandLine contains \"AGMAaAB1AG4AawBfAHMAaQB6AGUA\" or TargetProcessCommandLine contains \"JABjAGgAdQBuAGsAXwBzAGkAegBlA\" or TargetProcessCommandLine contains \"JGNodW5rX3Npem\" or TargetProcessCommandLine contains \"QAYwBoAHUAbgBrAF8AcwBpAHoAZQ\" or TargetProcessCommandLine contains \"RjaHVua19zaXpl\" or TargetProcessCommandLine contains \"Y2h1bmtfc2l6Z\" or TargetProcessCommandLine contains \"AE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4A\" or TargetProcessCommandLine contains \"kATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8Abg\" or TargetProcessCommandLine contains \"lPLkNvbXByZXNzaW9u\" or TargetProcessCommandLine contains \"SQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuA\" or TargetProcessCommandLine contains \"SU8uQ29tcHJlc3Npb2\" or TargetProcessCommandLine contains \"Ty5Db21wcmVzc2lvb\" or TargetProcessCommandLine contains \"AE8ALgBNAGUAbQBvAHIAeQBTAHQAcgBlAGEAbQ\" or TargetProcessCommandLine contains \"kATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtA\" or TargetProcessCommandLine contains \"lPLk1lbW9yeVN0cmVhb\" or TargetProcessCommandLine contains \"SQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0A\" or TargetProcessCommandLine contains \"SU8uTWVtb3J5U3RyZWFt\" or TargetProcessCommandLine contains \"Ty5NZW1vcnlTdHJlYW\" or TargetProcessCommandLine contains \"4ARwBlAHQAQwBoAHUAbgBrA\" or TargetProcessCommandLine contains \"5HZXRDaHVua\" or TargetProcessCommandLine contains \"AEcAZQB0AEMAaAB1AG4Aaw\" or TargetProcessCommandLine contains \"LgBHAGUAdABDAGgAdQBuAGsA\" or TargetProcessCommandLine contains \"LkdldENodW5r\" or TargetProcessCommandLine contains \"R2V0Q2h1bm\" or TargetProcessCommandLine contains \"AEgAUgBFAEEARABfAEkATgBGAE8ANgA0A\" or TargetProcessCommandLine contains \"QASABSAEUAQQBEAF8ASQBOAEYATwA2ADQA\" or TargetProcessCommandLine contains \"RIUkVBRF9JTkZPNj\" or TargetProcessCommandLine contains \"SFJFQURfSU5GTzY0\" or TargetProcessCommandLine contains \"VABIAFIARQBBAEQAXwBJAE4ARgBPADYANA\" or TargetProcessCommandLine contains \"VEhSRUFEX0lORk82N\" or TargetProcessCommandLine contains \"AHIAZQBhAHQAZQBSAGUAbQBvAHQAZQBUAGgAcgBlAGEAZA\" or TargetProcessCommandLine contains \"cmVhdGVSZW1vdGVUaHJlYW\" or TargetProcessCommandLine contains \"MAcgBlAGEAdABlAFIAZQBtAG8AdABlAFQAaAByAGUAYQBkA\" or TargetProcessCommandLine contains \"NyZWF0ZVJlbW90ZVRocmVhZ\" or TargetProcessCommandLine contains \"Q3JlYXRlUmVtb3RlVGhyZWFk\" or TargetProcessCommandLine contains \"QwByAGUAYQB0AGUAUgBlAG0AbwB0AGUAVABoAHIAZQBhAGQA\" or TargetProcessCommandLine contains \"0AZQBtAG0AbwB2AGUA\" or TargetProcessCommandLine contains \"1lbW1vdm\" or TargetProcessCommandLine contains \"AGUAbQBtAG8AdgBlA\" or TargetProcessCommandLine contains \"bQBlAG0AbQBvAHYAZQ\" or TargetProcessCommandLine contains \"bWVtbW92Z\" or TargetProcessCommandLine contains \"ZW1tb3Zl\"))|extend RuleId=\"f26c6093-6f14-4b12-800f-0fcb46f5ffd0\";\nlet q7=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessFilename =~ \"pwsh.dll\") and (TargetProcessCommandLine contains \"Set-Service \" and TargetProcessCommandLine contains \"DCLCWPDTSD\") and (TargetProcessCommandLine contains \"-SecurityDescriptorSddl \" or TargetProcessCommandLine contains \"-sd \"))|extend RuleId=\"514e4c3a-c77d-4cde-a00f-046425e2301e\";\nlet q8=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") and (TargetProcessCommandLine contains \" | iex;\" or TargetProcessCommandLine contains \" | iex \" or TargetProcessCommandLine contains \" | iex}\" or TargetProcessCommandLine contains \" | IEX ;\" or TargetProcessCommandLine contains \" | IEX -Error\" or TargetProcessCommandLine contains \" | IEX (new\" or TargetProcessCommandLine contains \");IEX \")) and (TargetProcessCommandLine contains \"::FromBase64String\" or TargetProcessCommandLine contains \".GetString([System.Convert]::\")) or (TargetProcessCommandLine contains \")|iex;$\" or TargetProcessCommandLine contains \");iex($\" or TargetProcessCommandLine contains \");iex $\" or TargetProcessCommandLine contains \" | IEX | \"))|extend RuleId=\"09576804-7a05-458e-a817-eb718ca91f54\";\nlet q9=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"Import-Certificate\" and TargetProcessCommandLine contains \" -FilePath \" and TargetProcessCommandLine contains \"Cert:\\\\LocalMachine\\\\Root\") and (TargetProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Temp\\\\\" or TargetProcessCommandLine contains \":\\\\Windows\\\\TEMP\\\\\" or TargetProcessCommandLine contains \"\\\\Desktop\\\\\" or TargetProcessCommandLine contains \"\\\\Downloads\\\\\" or TargetProcessCommandLine contains \"\\\\Perflogs\\\\\" or TargetProcessCommandLine contains \":\\\\Users\\\\Public\\\\\"))|extend RuleId=\"5f6a601c-2ecb-498b-9c33-660362323afa\";\nlet q10=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\") or (TargetProcessFilename =~ \"PowerShell.EXE\" or TargetProcessFilename =~ \"pwsh.dll\")) and (TargetProcessCommandLine contains \"curl \" or TargetProcessCommandLine contains \"Invoke-WebRequest\" or TargetProcessCommandLine contains \"iwr \" or TargetProcessCommandLine contains \"wget \") and (TargetProcessCommandLine contains \" -ur\" or TargetProcessCommandLine contains \" -o\") and (TargetProcessCommandLine contains \"\\\\AppData\\\\\" or TargetProcessCommandLine contains \"\\\\Desktop\\\\\" or TargetProcessCommandLine contains \"\\\\Temp\\\\\" or TargetProcessCommandLine contains \"\\\\Users\\\\Public\\\\\" or TargetProcessCommandLine contains \"%AppData%\" or TargetProcessCommandLine contains \"%Public%\" or TargetProcessCommandLine contains \"%Temp%\" or TargetProcessCommandLine contains \"%tmp%\" or TargetProcessCommandLine contains \"C:\\\\Windows\\\\\"))|extend RuleId=\"5e3cc4d8-3e68-43db-8656-eaaeefdec9cc\";\nunion q0, q1, q2, q3, q4, q5, q6, q7, q8, q9, q10;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Exfiltration", "PrivilegeEscalation", "CredentialAccess", "DefenseEvasion", "Persistence", "Execution", "CommandAndControl"],
                "techniques": ["T1059", "T1553", "T1574", "T1140", "T1027", "T1552", "T1105"],
                "alertRuleTemplateName": "5163A000-4c76-45a9-804d-dc3f355f2015",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}