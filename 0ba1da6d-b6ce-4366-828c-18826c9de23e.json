{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/0ba1da6d-b6ce-4366-828c-18826c9de23e')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/0ba1da6d-b6ce-4366-828c-18826c9de23e')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Potential Defense Evasion Via Rename Of Highly Relevant Binaries",
                "description": "Detects the execution of a renamed binary often used by attackers or malware leveraging new Sysmon OriginalFileName datapoint.; Author: Matthew Green - @mgreen27, Florian Roth (Nextron Systems), frack113; Source URL: process_creation/proc_creation_win_renamed_binary_highly_relevant.yml; Status: test; False Positives: Custom applications use renamed binaries adding slight change to binary name. Typically this is easy to spot and add to whitelist, PsExec installed via Windows Store doesn't contain original filename field (False negative); References: https://mgreen27.github.io/posts/2019/05/12/BinaryRename.html, https://mgreen27.github.io/posts/2019/05/29/BinaryRename2.html, https://www.trendmicro.com/vinfo/hk-en/security/news/cybercrime-and-digital-threats/megacortex-ransomware-spotted-attacking-enterprise-networks, https://twitter.com/christophetd/status/1164506034720952320, https://threatresearch.ext.hp.com/svcready-a-new-loader-reveals-itself/",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((TargetProcessFileDescription =~ \"Execute processes remotely\" or Product =~ \"Sysinternals PsExec\" or (TargetProcessFileDescription startswith \"Windows PowerShell\" or TargetProcessFileDescription startswith \"pwsh\") or (TargetProcessFilename =~ \"certutil.exe\" or TargetProcessFilename =~ \"cmstp.exe\" or TargetProcessFilename =~ \"cscript.exe\" or TargetProcessFilename =~ \"mshta.exe\" or TargetProcessFilename =~ \"msiexec.exe\" or TargetProcessFilename =~ \"powershell_ise.exe\" or TargetProcessFilename =~ \"powershell.exe\" or TargetProcessFilename =~ \"psexec.c\" or TargetProcessFilename =~ \"psexec.exe\" or TargetProcessFilename =~ \"psexesvc.exe\" or TargetProcessFilename =~ \"pwsh.dll\" or TargetProcessFilename =~ \"reg.exe\" or TargetProcessFilename =~ \"regsvr32.exe\" or TargetProcessFilename =~ \"rundll32.exe\" or TargetProcessFilename =~ \"WerMgr\" or TargetProcessFilename =~ \"wmic.exe\" or TargetProcessFilename =~ \"wscript.exe\")) and (not (TargetProcessName endswith \"\\\\certutil.exe\" or TargetProcessName endswith \"\\\\cmstp.exe\" or TargetProcessName endswith \"\\\\cscript.exe\" or TargetProcessName endswith \"\\\\mshta.exe\" or TargetProcessName endswith \"\\\\msiexec.exe\" or TargetProcessName endswith \"\\\\powershell_ise.exe\" or TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\psexec.exe\" or TargetProcessName endswith \"\\\\psexec64.exe\" or TargetProcessName endswith \"\\\\PSEXESVC.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessName endswith \"\\\\reg.exe\" or TargetProcessName endswith \"\\\\regsvr32.exe\" or TargetProcessName endswith \"\\\\rundll32.exe\" or TargetProcessName endswith \"\\\\wermgr.exe\" or TargetProcessName endswith \"\\\\wmic.exe\" or TargetProcessName endswith \"\\\\wscript.exe\")))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion"],
                "techniques": ["T1036.003"],
                "alertRuleTemplateName": "0ba1da6d-b6ce-4366-828c-18826c9de23e",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}