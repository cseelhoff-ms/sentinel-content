{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/66c3b204-9f88-4d0a-a7f7-8a57d521ca55')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/66c3b204-9f88-4d0a-a7f7-8a57d521ca55')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Potential Crypto Mining Activity",
                "description": "Detects command line parameters or strings often used by crypto miners\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_crypto_mining_monero.yml\nAuthor: Florian Roth (Nextron Systems)\nDate Modified: 2023-02-13\nStatus: stable\nReferences: https://www.poolwatch.io/coin/monero\nFalse Positives: Legitimate use of crypto miners, Some build frameworks",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \" --cpu-priority=\" or TargetProcessCommandLine contains \"--donate-level=0\" or TargetProcessCommandLine contains \" -o pool.\" or TargetProcessCommandLine contains \" --nicehash\" or TargetProcessCommandLine contains \" --algo=rx/0 \" or TargetProcessCommandLine contains \"stratum+tcp://\" or TargetProcessCommandLine contains \"stratum+udp://\" or TargetProcessCommandLine contains \"LS1kb25hdGUtbGV2ZWw9\" or TargetProcessCommandLine contains \"0tZG9uYXRlLWxldmVsP\" or TargetProcessCommandLine contains \"tLWRvbmF0ZS1sZXZlbD\" or TargetProcessCommandLine contains \"c3RyYXR1bSt0Y3A6Ly\" or TargetProcessCommandLine contains \"N0cmF0dW0rdGNwOi8v\" or TargetProcessCommandLine contains \"zdHJhdHVtK3RjcDovL\" or TargetProcessCommandLine contains \"c3RyYXR1bSt1ZHA6Ly\" or TargetProcessCommandLine contains \"N0cmF0dW0rdWRwOi8v\" or TargetProcessCommandLine contains \"zdHJhdHVtK3VkcDovL\") and (not((TargetProcessCommandLine contains \" pool.c \" or TargetProcessCommandLine contains \" pool.o \" or TargetProcessCommandLine contains \"gcc -\"))))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Impact"],
                "techniques": ["T1496"],
                "alertRuleTemplateName": "66c3b204-9f88-4d0a-a7f7-8a57d521ca55",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}