{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-4c76-45a9-804d-dc3f355f1013')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-4c76-45a9-804d-dc3f355f1013')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation medium 013",
                "description": "Sigma Windows Process Creation medium 013",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\rundll32.exe\" or TargetProcessFilename =~ \"RUNDLL32.EXE\") and ActingProcessName endswith \"\\\\cmd.exe\" and TargetProcessCommandLine contains \"user32.dll,\" and TargetProcessCommandLine contains \"LockWorkStation\")|extend RuleId=\"3b5b0213-0460-4e3f-8937-3abf98ff7dcc\";\nlet q1=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\svchost.exe\" and (TargetProcessName endswith \"\\\\rundll32.exe\" or TargetProcessFilename =~ \"RUNDLL32.EXE\") and TargetProcessCommandLine contains \"C:\\\\windows\\\\system32\\\\davclnt.dll,DavSetCookie\")|extend RuleId=\"2dbd9d3d-9e27-42a8-b8df-f13825c6c3d5\";\nlet q2=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\schtasks.exe\" and TargetProcessCommandLine contains \"/Create \") and (TargetProcessCommandLine contains \"/TN \\\"{\" or TargetProcessCommandLine contains \"/TN '{\" or TargetProcessCommandLine contains \"/TN {\") and (TargetProcessCommandLine contains \"}\\\"\" or TargetProcessCommandLine contains \"}'\" or TargetProcessCommandLine contains \"} \"))|extend RuleId=\"ff2fff64-4cd6-4a2b-ba7d-e28a30bbe66b\";\nlet q3=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\schtasks.exe\" and TargetProcessCommandLine contains \"/Create \" and (ActingProcessName contains \"\\\\AppData\\\\Local\\\\\" or ActingProcessName contains \"\\\\AppData\\\\Roaming\\\\\" or ActingProcessName contains \"\\\\Temporary Internet\" or ActingProcessName contains \"\\\\Users\\\\Public\\\\\")) and (not((TargetProcessCommandLine contains \"update_task.xml\" or TargetProcessCommandLine contains \"unattended.ini\"))))|extend RuleId=\"9494479d-d994-40bf-a8b1-eea890237021\";\nlet q4=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessFilename =~ \"schtasks.exe\") and (TargetProcessCommandLine contains \"run \" and TargetProcessCommandLine contains \"\\\\Application Experience\\\\Microsoft Compatibility Appraiser\"))|extend RuleId=\"f548a603-c9f2-4c89-b511-b089f7e94549\";\nlet q5=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessFilename =~ \"schtasks.exe\") and TargetProcessCommandLine contains \"/Create\" and (TargetProcessCommandLine contains \"Get-ItemProperty\" or TargetProcessCommandLine contains \" gp \") and (TargetProcessCommandLine contains \"HKCU:\" or TargetProcessCommandLine contains \"HKLM:\" or TargetProcessCommandLine contains \"registry::\" or TargetProcessCommandLine contains \"HKEY_\")) and (not((TargetProcessCommandLine contains \"FromBase64String\" or TargetProcessCommandLine contains \"encodedcommand\"))))|extend RuleId=\"86588b36-c6d3-465f-9cee-8f9093e07798\";\nlet q6=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessFilename =~ \"schtasks.exe\") and (TargetProcessCommandLine contains \" ONLOGON \" or TargetProcessCommandLine contains \" ONSTART \" or TargetProcessCommandLine contains \" ONCE \" or TargetProcessCommandLine contains \" ONIDLE \") and (TargetProcessCommandLine contains \"NT AUT\" or TargetProcessCommandLine contains \" SYSTEM\" or TargetProcessCommandLine contains \"HIGHEST\"))|extend RuleId=\"7a02e22e-b885-4404-b38b-1ddc7e65258a\";\nlet q7=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessFilename =~ \"schtasks.exe\") and (TargetProcessCommandLine contains \"/create\" or TargetProcessCommandLine contains \"-create\") and (TargetProcessCommandLine contains \"/xml\" or TargetProcessCommandLine contains \"-xml\")) and (not((TargetProcessCommandLine contains \".xml\" or TargetProcessIntegrityLevel =~ \"System\" or (ActingProcessName endswith \"\\\\rundll32.exe\" and (ActingProcessCommandLine contains \":\\\\WINDOWS\\\\Installer\\\\MSI\" and ActingProcessCommandLine contains \".tmp,zzzzInvokeManagedCustomActionOutOfProc\"))))) and (not((ActingProcessName match \":\\\\ProgramData\\\\OEM\\\\UpgradeTool\\\\CareCenter_\\\\BUnzip\\\\Setup_msi.exe\" or ActingProcessName endswith \":\\\\Program Files\\\\Axis Communications\\\\AXIS Camera Station\\\\SetupActions.exe\" or ActingProcessName endswith \":\\\\Program Files\\\\Axis Communications\\\\AXIS Device Manager\\\\AdmSetupActions.exe\" or ActingProcessName endswith \":\\\\Program Files (x86)\\\\Zemana\\\\AntiMalware\\\\AntiMalware.exe\" or ActingProcessName endswith \":\\\\Program Files\\\\Dell\\\\SupportAssist\\\\pcdrcui.exe\"))))|extend RuleId=\"dd2a821e-3b07-4d3b-a9ac-929fe4c6ca0c\";\nlet q8=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\sc.exe\" or TargetProcessFilename =~ \"sc.exe\") and ((TargetProcessCommandLine contains \" config \" and TargetProcessCommandLine contains \"start\") and (TargetProcessCommandLine contains \"disabled\" or TargetProcessCommandLine contains \"demand\")))|extend RuleId=\"85c312b7-f44d-4a51-a024-d671c40b49fc\";\nlet q9=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\sc.exe\" and (TargetProcessCommandLine contains \"create\" or TargetProcessCommandLine contains \"config\") and (TargetProcessCommandLine contains \"binPath\" and TargetProcessCommandLine contains \"type\" and TargetProcessCommandLine contains \"kernel\"))|extend RuleId=\"431a1fdb-4799-4f3b-91c3-a683b003fc49\";\nlet q10=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\sc.exe\" or TargetProcessFilename =~ \"sc.exe\") and TargetProcessCommandLine contains \"sdset\")|extend RuleId=\"98c5aeef-32d5-492f-b174-64a691896d25\";\nlet q11=_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"sc \" and TargetProcessCommandLine contains \"config \" and TargetProcessCommandLine contains \"binpath=\") or (TargetProcessCommandLine contains \"sc \" and TargetProcessCommandLine contains \"failure\" and TargetProcessCommandLine contains \"command=\")) or (((TargetProcessCommandLine contains \"reg \" and TargetProcessCommandLine contains \"add \" and TargetProcessCommandLine contains \"FailureCommand\") or (TargetProcessCommandLine contains \"reg \" and TargetProcessCommandLine contains \"add \" and TargetProcessCommandLine contains \"ImagePath\")) and (TargetProcessCommandLine contains \".sh\" or TargetProcessCommandLine contains \".exe\" or TargetProcessCommandLine contains \".dll\" or TargetProcessCommandLine contains \".bin$\" or TargetProcessCommandLine contains \".bat\" or TargetProcessCommandLine contains \".cmd\" or TargetProcessCommandLine contains \".js\" or TargetProcessCommandLine contains \".msh$\" or TargetProcessCommandLine contains \".reg$\" or TargetProcessCommandLine contains \".scr\" or TargetProcessCommandLine contains \".ps\" or TargetProcessCommandLine contains \".vb\" or TargetProcessCommandLine contains \".jar\" or TargetProcessCommandLine contains \".pl\")))|extend RuleId=\"38879043-7e1e-47a9-8d46-6bec88e201df\";\nlet q12=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\sdbinst.exe\" or TargetProcessFilename =~ \"sdbinst.exe\") and TargetProcessCommandLine contains \".sdb\") and (not((ActingProcessName endswith \"\\\\msiexec.exe\" and TargetProcessCommandLine contains \"iisexpressshim.sdb\"))))|extend RuleId=\"517490a7-115a-48c6-8862-1a481504d5a8\";\nlet q13=_Im_ProcessCreate\n| where ActingProcessName endswith \"\\\\sdclt.exe\"|extend RuleId=\"da2738f2-fadb-4394-afa7-0a0674885afa\";\nlet q14=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\secedit.exe\" or TargetProcessFilename =~ \"SeCEdit\") and ((TargetProcessCommandLine contains \"/export\" and TargetProcessCommandLine contains \"/cfg\") or (TargetProcessCommandLine contains \"/configure\" and TargetProcessCommandLine contains \"/db\")))|extend RuleId=\"c2c76b77-32be-4d1f-82c9-7e544bdfe0eb\";\nlet q15=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\setspn.exe\" or TargetProcessFilename =~ \"setspn.exe\" or (TargetProcessFileDescription contains \"Query or reset the computer\" and TargetProcessFileDescription contains \"SPN attribute\")) and (TargetProcessCommandLine contains \" -q \" or TargetProcessCommandLine contains \" /q \"))|extend RuleId=\"1eeed653-dbc8-4187-ad0c-eeebb20e6599\";\nlet q16=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\shutdown.exe\" and (TargetProcessCommandLine contains \"/r \" or TargetProcessCommandLine contains \"/s \"))|extend RuleId=\"34ebb878-1b15-4895-b352-ca2eeb99b274\";\nlet q17=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\shutdown.exe\" and TargetProcessCommandLine contains \"/l\")|extend RuleId=\"ec290c06-9b6b-4338-8b6b-095c0f284f10\";\nlet q18=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\SndVol.exe\" and (not((TargetProcessName endswith \"\\\\rundll32.exe\" and TargetProcessCommandLine contains \" shell32.dll,Control_RunDLL \"))))|extend RuleId=\"ba42babc-0666-4393-a4f7-ceaf5a69191e\";\nlet q19=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\SoundRecorder.exe\" and TargetProcessCommandLine contains \"/FILE\")|extend RuleId=\"83865853-59aa-449e-9600-74b9d89a6d6e\";\nlet q20=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\sqlcmd.exe\" and (TargetProcessCommandLine contains \"VeeamBackup\" and TargetProcessCommandLine contains \"From \")) and (TargetProcessCommandLine contains \"BackupRepositories\" or TargetProcessCommandLine contains \"Backups\" or TargetProcessCommandLine contains \"Credentials\" or TargetProcessCommandLine contains \"HostCreds\" or TargetProcessCommandLine contains \"SmbFileShares\" or TargetProcessCommandLine contains \"Ssh_creds\" or TargetProcessCommandLine contains \"VSphereInfo\"))|extend RuleId=\"696bfb54-227e-4602-ac5b-30d9d2053312\";\nlet q21=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\amazon-ssm-agent.exe\" and (TargetProcessCommandLine contains \"-register \" and TargetProcessCommandLine contains \"-code \" and TargetProcessCommandLine contains \"-id \" and TargetProcessCommandLine contains \"-region \"))|extend RuleId=\"d20ee2f4-822c-4827-9e15-41500b1fff10\";\nlet q22=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\ntvdm.exe\" or TargetProcessName endswith \"\\\\csrstub.exe\")|extend RuleId=\"16905e21-66ee-42fe-b256-1318ada2d770\";\nlet q23=_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"localgroup \" and TargetProcessCommandLine contains \" /add\") or (TargetProcessCommandLine contains \"Add-LocalGroupMember \" and TargetProcessCommandLine contains \" -Group \")) and (TargetProcessCommandLine contains \" administrators \" or TargetProcessCommandLine contains \" administrateur\"))|extend RuleId=\"ad720b90-25ad-43ff-9b5e-5c841facc8e5\";\nunion q0, q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11, q12, q13, q14, q15, q16, q17, q18, q19, q20, q21, q22, q23;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["PrivilegeEscalation", "Discovery", "Collection", "Impact", "DefenseEvasion", "CommandAndControl", "Exfiltration", "CredentialAccess", "Persistence", "Execution"],
                "techniques": ["T1505", "T1574", "T1562", "T1556", "T1564", "T1059", "T1036", "T1546", "T1219", "T1543", "T1048", "T1005", "T1053", "T1123", "T1558", "T1098", "T1548", "T1557", "T1529", "T1547", "T1082"],
                "alertRuleTemplateName": "5163A000-4c76-45a9-804d-dc3f355f1013",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}