{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-5160-5160-5160-5163A0000230')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-5160-5160-5160-5163A0000230')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 30",
                "description": "Sigma Windows Process Creation medium 30",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"143Svc\" or TargetProcessCommandLine contains \"Acronis VSS Provider\" or TargetProcessCommandLine contains \"AcronisAgent\" or TargetProcessCommandLine contains \"AcrSch2Svc\" or TargetProcessCommandLine contains \"Antivirus\" or TargetProcessCommandLine contains \"ARSM\" or TargetProcessCommandLine contains \"aswBcc\" or TargetProcessCommandLine contains \"Avast Business Console Client Antivirus Service\" or TargetProcessCommandLine contains \"avast! Antivirus\" or TargetProcessCommandLine contains \"AVG Antivirus\" or TargetProcessCommandLine contains \"avgAdminClient\" or TargetProcessCommandLine contains \"AvgAdminServer\" or TargetProcessCommandLine contains \"AVP1\" or TargetProcessCommandLine contains \"BackupExec\" or TargetProcessCommandLine contains \"bedbg\" or TargetProcessCommandLine contains \"BITS\" or TargetProcessCommandLine contains \"BrokerInfrastructure\" or TargetProcessCommandLine contains \"Client Agent 760\" or TargetProcessCommandLine contains \"Core Browsing Protection\" or TargetProcessCommandLine contains \"Core Mail Protection\" or TargetProcessCommandLine contains \"Core Scanning Server\" or TargetProcessCommandLine contains \"DCAgent\" or TargetProcessCommandLine contains \"EhttpSr\" or TargetProcessCommandLine contains \"ekrn\" or TargetProcessCommandLine contains \"Enterprise Client Service\" or TargetProcessCommandLine contains \"epag\" or TargetProcessCommandLine contains \"EPIntegrationService\" or TargetProcessCommandLine contains \"EPProtectedService\" or TargetProcessCommandLine contains \"EPRedline\" or TargetProcessCommandLine contains \"EPSecurityService\" or TargetProcessCommandLine contains \"EPUpdateService\" or TargetProcessCommandLine contains \"EraserSvc11710\" or TargetProcessCommandLine contains \"EsgShKernel\" or TargetProcessCommandLine contains \"ESHASRV\" or TargetProcessCommandLine contains \"FA_Scheduler\" or TargetProcessCommandLine contains \"FirebirdGuardianDefaultInstance\" or TargetProcessCommandLine contains \"FirebirdServerDefaultInstance\" or TargetProcessCommandLine contains \"HealthTLService\" or TargetProcessCommandLine contains \"MSSQLFDLauncher$\" or TargetProcessCommandLine contains \"hmpalertsvc\" or TargetProcessCommandLine contains \"HMS\" or TargetProcessCommandLine contains \"IISAdmin\" or TargetProcessCommandLine contains \"IMANSVC\" or TargetProcessCommandLine contains \"IMAP4Svc\" or TargetProcessCommandLine contains \"KAVFS\" or TargetProcessCommandLine contains \"KAVFSGT\" or TargetProcessCommandLine contains \"kavfsslp\" or TargetProcessCommandLine contains \"klbackupdisk\" or TargetProcessCommandLine contains \"klbackupflt\" or TargetProcessCommandLine contains \"klflt\" or TargetProcessCommandLine contains \"klhk\" or TargetProcessCommandLine contains \"KLIF\" or TargetProcessCommandLine contains \"klim6\" or TargetProcessCommandLine contains \"klkbdflt\" or TargetProcessCommandLine contains \"klmouflt\" or TargetProcessCommandLine contains \"klnagent\" or TargetProcessCommandLine contains \"klpd\" or TargetProcessCommandLine contains \"kltap\" or TargetProcessCommandLine contains \"KSDE100\" or TargetProcessCommandLine contains \"LogProcessorService\" or TargetProcessCommandLine contains \"M8EndpointAgent\" or TargetProcessCommandLine contains \"macmnsvc\" or TargetProcessCommandLine contains \"masvc\" or TargetProcessCommandLine contains \"MBAMService\" or TargetProcessCommandLine contains \"MBCloudEA\" or TargetProcessCommandLine contains \"MBEndpointAgent\" or TargetProcessCommandLine contains \"McAfeeDLPAgentService\" or TargetProcessCommandLine contains \"McAfeeEngineService\" or TargetProcessCommandLine contains \"MCAFEEEVENTPARSERSRV\" or TargetProcessCommandLine contains \"McAfeeFramework\" or TargetProcessCommandLine contains \"MCAFEETOMCATSRV530\" or TargetProcessCommandLine contains \"McShield\" or TargetProcessCommandLine contains \"McTaskManager\" or TargetProcessCommandLine contains \"mfefire\" or TargetProcessCommandLine contains \"mfemms\" or TargetProcessCommandLine contains \"mfevto\" or TargetProcessCommandLine contains \"mfevtp\" or TargetProcessCommandLine contains \"mfewc\" or TargetProcessCommandLine contains \"MMS\" or TargetProcessCommandLine contains \"mozyprobackup\" or TargetProcessCommandLine contains \"MsDtsServer\" or TargetProcessCommandLine contains \"MSExchange\" or TargetProcessCommandLine contains \"msftesq1SPROO\" or TargetProcessCommandLine contains \"msftesql$PROD\" or TargetProcessCommandLine contains \"MSOLAP$SQL_2008\" or TargetProcessCommandLine contains \"MSOLAP$SYSTEM_BGC\" or TargetProcessCommandLine contains \"MSOLAP$TPS\" or TargetProcessCommandLine contains \"MSOLAP$TPSAMA\" or TargetProcessCommandLine contains \"MSOLAPSTPS\" or TargetProcessCommandLine contains \"MSOLAPSTPSAMA\" or TargetProcessCommandLine contains \"mssecflt\" or TargetProcessCommandLine contains \"MSSQ!ISPROFXENGAGEMEHT\" or TargetProcessCommandLine contains \"MSSQ0SHAREPOINT\" or TargetProcessCommandLine contains \"MSSQ0SOPHOS\" or TargetProcessCommandLine contains \"MSSQL\" or TargetProcessCommandLine contains \"MySQL\" or TargetProcessCommandLine contains \"NanoServiceMain\" or TargetProcessCommandLine contains \"NetMsmqActivator\" or TargetProcessCommandLine contains \"ntrtscan\" or TargetProcessCommandLine contains \"ofcservice\" or TargetProcessCommandLine contains \"Online Protection System\" or TargetProcessCommandLine contains \"OracleClientCache80\" or TargetProcessCommandLine contains \"PandaAetherAgent\" or TargetProcessCommandLine contains \"PccNTUpd\" or TargetProcessCommandLine contains \"PDVFSService\" or TargetProcessCommandLine contains \"POP3Svc\" or TargetProcessCommandLine contains \"POVFSService\" or TargetProcessCommandLine contains \"PSUAService\" or TargetProcessCommandLine contains \"Quick Update Service\" or TargetProcessCommandLine contains \"RepairService\" or TargetProcessCommandLine contains \"ReportServer\" or TargetProcessCommandLine contains \"ReportServer$\" or TargetProcessCommandLine contains \"RESvc\" or TargetProcessCommandLine contains \"RpcEptMapper\" or TargetProcessCommandLine contains \"sacsvr\" or TargetProcessCommandLine contains \"SamSs\" or TargetProcessCommandLine contains \"SAVAdminService\" or TargetProcessCommandLine contains \"SAVService\" or TargetProcessCommandLine contains \"ScSecSvc\" or TargetProcessCommandLine contains \"SDRSVC\" or TargetProcessCommandLine contains \"sense\" or TargetProcessCommandLine contains \"SentinelAgent\" or TargetProcessCommandLine contains \"SentinelHelperService\" or TargetProcessCommandLine contains \"SepMasterService\" or TargetProcessCommandLine contains \"ShMonitor\" or TargetProcessCommandLine contains \"Smcinst\" or TargetProcessCommandLine contains \"SmcService\" or TargetProcessCommandLine contains \"SMTPSvc\" or TargetProcessCommandLine contains \"SNAC\" or TargetProcessCommandLine contains \"SntpService\" or TargetProcessCommandLine contains \"Sophos\" or TargetProcessCommandLine contains \"SQ1SafeOLRService\" or TargetProcessCommandLine contains \"SQL Backups\" or TargetProcessCommandLine contains \"SQL Server\" or TargetProcessCommandLine contains \"SQLAgent\" or TargetProcessCommandLine contains \"SQLBrowser\" or TargetProcessCommandLine contains \"SQLsafe\" or TargetProcessCommandLine contains \"SQLSERVERAGENT\" or TargetProcessCommandLine contains \"SQLTELEMETRY\" or TargetProcessCommandLine contains \"SQLWriter\" or TargetProcessCommandLine contains \"SSISTELEMETRY130\" or TargetProcessCommandLine contains \"SstpSvc\" or TargetProcessCommandLine contains \"svcGenericHost\" or TargetProcessCommandLine contains \"swc_service\" or TargetProcessCommandLine contains \"swi_filter\" or TargetProcessCommandLine contains \"swi_service\" or TargetProcessCommandLine contains \"swi_update\" or TargetProcessCommandLine contains \"Symantec\" or TargetProcessCommandLine contains \"Telemetryserver\" or TargetProcessCommandLine contains \"ThreatLockerService\" or TargetProcessCommandLine contains \"TMBMServer\" or TargetProcessCommandLine contains \"TmCCSF\" or TargetProcessCommandLine contains \"TmFilter\" or TargetProcessCommandLine contains \"TMiCRCScanService\" or TargetProcessCommandLine contains \"tmlisten\" or TargetProcessCommandLine contains \"TMLWCSService\" or TargetProcessCommandLine contains \"TmPfw\" or TargetProcessCommandLine contains \"TmPreFilter\" or TargetProcessCommandLine contains \"TmProxy\" or TargetProcessCommandLine contains \"TMSmartRelayService\" or TargetProcessCommandLine contains \"tmusa\" or TargetProcessCommandLine contains \"Trend Micro Deep Security Manager\" or TargetProcessCommandLine contains \"TrueKey\" or TargetProcessCommandLine contains \"UI0Detect\" or TargetProcessCommandLine contains \"UTODetect\" or TargetProcessCommandLine contains \"Veeam\" or TargetProcessCommandLine contains \"VeeamDeploySvc\" or TargetProcessCommandLine contains \"Veritas System Recovery\" or TargetProcessCommandLine contains \"VSApiNt\" or TargetProcessCommandLine contains \"VSS\" or TargetProcessCommandLine contains \"W3Svc\" or TargetProcessCommandLine contains \"wbengine\" or TargetProcessCommandLine contains \"WdNisSvc\" or TargetProcessCommandLine contains \"WeanClOudSve\" or TargetProcessCommandLine contains \"Weems JY\" or TargetProcessCommandLine contains \"WinDefend\" or TargetProcessCommandLine contains \"wozyprobackup\" or TargetProcessCommandLine contains \"WRSVC\" or TargetProcessCommandLine contains \"Zoolz 2 Service\") and ((((TargetProcessFilename =~ \"netexe\" or TargetProcessFilename =~ \"net1exe\") or (TargetProcessName endswith \"\\\\netexe\" or TargetProcessName endswith \"\\\\net1exe\")) and TargetProcessCommandLine contains \" stop \") or (((TargetProcessFilename =~ \"PowerShellEXE\" or TargetProcessFilename =~ \"pwshdll\") or (TargetProcessName endswith \"\\\\powershellexe\" or TargetProcessName endswith \"\\\\pwshexe\")) and (TargetProcessCommandLine contains \"Stop-Service \" or TargetProcessCommandLine contains \"Remove-Service \")) or ((TargetProcessFilename =~ \"scexe\" or TargetProcessName endswith \"\\\\scexe\") and (TargetProcessCommandLine contains \" stop \" or TargetProcessCommandLine contains \" delete \" or TargetProcessCommandLine contains \" pause \"))))|extend RuleId=\"5163A000-5160-5160-5160-5163A0000229\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_service_tamper.yml\";\nlet q1=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershellexe\" or TargetProcessName endswith \"\\\\pwshexe\" or TargetProcessName endswith \"\\\\wmicexe\" or TargetProcessName endswith \"\\\\vssadminexe\" or TargetProcessName endswith \"\\\\diskshadowexe\") or (TargetProcessFilename =~ \"PowerShellEXE\" or TargetProcessFilename =~ \"pwshdll\" or TargetProcessFilename =~ \"wmicexe\" or TargetProcessFilename =~ \"VSSADMINEXE\" or TargetProcessFilename =~ \"diskshadowexe\")) and (TargetProcessCommandLine contains \"shadow\" and TargetProcessCommandLine contains \"delete\")) or ((TargetProcessName endswith \"\\\\wbadminexe\" or TargetProcessFilename =~ \"WBADMINEXE\") and (TargetProcessCommandLine contains \"delete\" and TargetProcessCommandLine contains \"catalog\" and TargetProcessCommandLine contains \"quiet\")) or ((TargetProcessName endswith \"\\\\vssadminexe\" or TargetProcessFilename =~ \"VSSADMINEXE\") and ((TargetProcessCommandLine contains \"resize\" and TargetProcessCommandLine contains \"shadowstorage\") and (TargetProcessCommandLine contains \"unbounded\" or TargetProcessCommandLine contains \"/MaxSize=\"))))|extend RuleId=\"c947b146-0abc-4c87-9c64-b17e9d7274a2\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_shadow_copies_deletion.yml\";\nlet q2=_Im_ProcessCreate\n| where (((ActingProcessName endswith \"\\\\mshtaexe\" or ActingProcessName endswith \"\\\\powershellexe\" or ActingProcessName endswith \"\\\\pwshexe\" or ActingProcessName endswith \"\\\\rundll32exe\" or ActingProcessName endswith \"\\\\cscriptexe\" or ActingProcessName endswith \"\\\\wscriptexe\" or ActingProcessName endswith \"\\\\wmiprvseexe\" or ActingProcessName endswith \"\\\\regsvr32exe\") and (TargetProcessName endswith \"\\\\schtasksexe\" or TargetProcessName endswith \"\\\\nslookupexe\" or TargetProcessName endswith \"\\\\certutilexe\" or TargetProcessName endswith \"\\\\bitsadminexe\" or TargetProcessName endswith \"\\\\mshtaexe\")) and (not((TargetProcessCurrentDirectory contains \"\\\\ccmcache\\\\\" or (ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\setup-scheduledtaskps1\" or ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\set-selfhealingps1\" or ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\check-workspacehealthps1\" or ActingProcessCommandLine contains \"\\\\nessus_\") or TargetProcessCommandLine contains \"\\\\nessus_\" or (ActingProcessName endswith \"\\\\mshtaexe\" and TargetProcessName endswith \"\\\\mshtaexe\" and (ActingProcessCommandLine contains \"C:\\\\MEM_Configmgr_\" and ActingProcessCommandLine contains \"\\\\splashhta\" and ActingProcessCommandLine contains \"{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}\") and (TargetProcessCommandLine contains \"C:\\\\MEM_Configmgr_\" and TargetProcessCommandLine contains \"\\\\SMSSETUP\\\\BIN\\\\\" and TargetProcessCommandLine contains \"\\\\autorunhta\" and TargetProcessCommandLine contains \"{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}\"))))))|extend RuleId=\"3a6586ad-127a-4d3b-a677-1e6eacdf8fde\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_shell_spawn_susp_program.yml\";\nunion q0, q1, q2;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion", "Execution", "Impact"],
                "techniques": ["T1218", "T1490", "T1070", "T1489", "T1059"],
                "alertRuleTemplateName": "5163A000-5160-5160-5160-5163A0000230",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}