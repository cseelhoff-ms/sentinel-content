{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-5160-5160-5160-5163A0000205')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-5160-5160-5160-5163A0000205')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 05",
                "description": "Sigma Windows Process Creation medium 05",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\crackmapexecexe\" or TargetProcessCommandLine contains \" -M pe_inject \" or (TargetProcessCommandLine contains \" --local-auth\" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -x \") or (TargetProcessCommandLine contains \" --local-auth\" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -p \" and TargetProcessCommandLine contains \" -H 'NTHASH'\") or (TargetProcessCommandLine contains \" mssql \" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -p \" and TargetProcessCommandLine contains \" -M \" and TargetProcessCommandLine contains \" -d \") or (TargetProcessCommandLine contains \" smb \" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -H \" and TargetProcessCommandLine contains \" -M \" and TargetProcessCommandLine contains \" -o \") or (TargetProcessCommandLine contains \" smb \" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -p \" and TargetProcessCommandLine contains \" --local-auth\")) or ((TargetProcessCommandLine contains \" --local-auth\" and TargetProcessCommandLine contains \" -u \" and TargetProcessCommandLine contains \" -p \") and (TargetProcessCommandLine contains \" 10\" and TargetProcessCommandLine contains \" 192168\" and TargetProcessCommandLine contains \"/24 \")))|extend RuleId=\"5163A000-5160-5160-5160-5163A0000204\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_crackmapexec_execution.yml\";\nlet q1=_Im_ProcessCreate\n| where ((TargetProcessCommandLine matches regex \"\".*cmdexe /Q /c .* 1> \\\\\\\\.*\\\\.*\\\\.* 2>&1\"\" or TargetProcessCommandLine matches regex \"\".*cmdexe /C .* > \\\\\\\\.*\\\\.*\\\\.* 2>&1\"\" or TargetProcessCommandLine matches regex \"\".*cmdexe /C .* > .*\\\\Temp\\\\.* 2>&1\"\") and (TargetProcessCommandLine contains \"powershellexe -exec bypass -noni -nop -w 1 -C \\\"\" or TargetProcessCommandLine contains \"powershellexe -noni -nop -w 1 -enc \"))|extend RuleId=\"058f4380-962d-40a5-afce-50207d36d7e2\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_crackmapexec_execution_patterns.yml\";\nlet q2=_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"tasklist /fi \" and TargetProcessCommandLine contains \"Imagename eq lsassexe\") and (TargetProcessCommandLine contains \"cmdexe /c \" or TargetProcessCommandLine contains \"cmdexe /r \" or TargetProcessCommandLine contains \"cmdexe /k \" or TargetProcessCommandLine contains \"cmd /c \" or TargetProcessCommandLine contains \"cmd /r \" or TargetProcessCommandLine contains \"cmd /k \") and (TargetUsername contains \"AUTHORI\" or TargetUsername contains \"AUTORI\")) or (TargetProcessCommandLine contains \"do rundll32exe C:\\\\windows\\\\System32\\\\comsvcsdll, MiniDump\" and TargetProcessCommandLine contains \"\\\\Windows\\\\Temp\\\\\" and TargetProcessCommandLine contains \" full\" and TargetProcessCommandLine contains \"%%B\") or (TargetProcessCommandLine contains \"tasklist /v /fo csv\" and TargetProcessCommandLine contains \"findstr /i \\\"lsass\\\"\"))|extend RuleId=\"f26307d8-14cd-47e3-a26b-4b4769f24af6\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_crackmapexec_patterns.yml\";\nlet q3=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\powershellexe\" or TargetProcessName endswith \"\\\\pwshexe\") or (TargetProcessFilename =~ \"PowerShellEXE\" or TargetProcessFilename =~ \"pwshdll\")) and (TargetProcessCommandLine matches regex \"\".*join.*split.*\"\" or TargetProcessCommandLine contains \"( $ShellId[1]+$ShellId[13]+'x')\" or TargetProcessCommandLine matches regex \"\".*( $PSHome[.*]+$PSHOME[.*]+.*\"\" or TargetProcessCommandLine contains \"( $env:Public[13]+$env:Public[5]+'x')\" or TargetProcessCommandLine matches regex \"\".*( $env:ComSpec[4,.*,25]-Join'').*\"\" or TargetProcessCommandLine contains \"[1,3]+'x'-Join'')\"))|extend RuleId=\"6f8b3439-a203-45dc-a88b-abf57ea15ccf\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_crackmapexec_powershell_obfuscation.yml\";\nlet q4=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\CreateMiniDumpexe\" or TargetProcessIMPHASH =~ \"4a07f944a83e8a7c2525efa35dd30e2f\" or Hashes contains \"IMPHASH=4a07f944a83e8a7c2525efa35dd30e2f\")|extend RuleId=\"36d88494-1d43-4dc0-b3fa-35c8fea0ca9d\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_createminidump.yml\";\nlet q5=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \" -NoP -sta -NonI -W Hidden -Enc \" or TargetProcessCommandLine contains \" -noP -sta -w 1 -enc \" or TargetProcessCommandLine contains \" -NoP -NonI -W Hidden -enc \" or TargetProcessCommandLine contains \" -noP -sta -w 1 -enc\" or TargetProcessCommandLine contains \" -enc  SQB\" or TargetProcessCommandLine contains \" -nop -exec bypass -EncodedCommand \")|extend RuleId=\"79f4ede3-402e-41c8-bc3e-ebbf5f162581\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_empire_powershell_launch.yml\";\nlet q6=_Im_ProcessCreate\n| where TargetProcessFileCompany =~ \"Cube0x0\"|extend RuleId=\"37c1333a-a0db-48be-b64b-7393b2386e3b\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_execution_via_pe_metadata.yml\";\nlet q7=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\gmerexe\" or (Hashes contains \"MD5=E9DC058440D321AA17D0600B3CA0AB04\" or Hashes contains \"SHA1=539C228B6B332F5AA523E5CE358C16647D8BBE57\" or Hashes contains \"SHA256=E8A3E804A96C716A3E9B69195DB6FFB0D33E2433AF871E4D4E1EAB3097237173\") or (md5 =~ \"e9dc058440d321aa17d0600b3ca0ab04\" or sha1 =~ \"539c228b6b332f5aa523e5ce358c16647d8bbe57\" or sha256 =~ \"e8a3e804a96c716a3e9b69195db6ffb0d33e2433af871e4d4e1eab3097237173\"))|extend RuleId=\"9082ff1f-88ab-4678-a3cc-5bcff99fc74d\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_gmer.yml\";\nlet q8=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\loaderexe\" and TargetProcessCommandLine contains \"--pid:\") or ((TargetProcessIMPHASH =~ \"38d9e015591bbfd4929e0d0f47fa0055\" or TargetProcessIMPHASH =~ \"0e2216679ca6e1094d63322e3412d650\") or (Hashes =~ \"IMPHASH=38D9E015591BBFD4929E0D0F47FA0055\" or Hashes =~ \"IMPHASH=0E2216679CA6E1094D63322E3412D650\")) or ((TargetProcessCommandLine contains \"--pid:\" and TargetProcessCommandLine contains \"--outfile:\") and (TargetProcessCommandLine contains \"dmp\" or TargetProcessCommandLine contains \"lsass\" or TargetProcessCommandLine contains \"obf\" or TargetProcessCommandLine contains \"dump\")))|extend RuleId=\"ca621ba5-54ab-4035-9942-d378e6fcde3c\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_handlekatz.yml\";\nlet q9=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\hashcatexe\" or (TargetProcessCommandLine contains \"-a \" and TargetProcessCommandLine contains \"-m 1000 \" and TargetProcessCommandLine contains \"-r \"))|extend RuleId=\"39b31e81-5f5f-4898-9c0e-2160cfc0f9bf\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_hashcat.yml\";\nlet q10=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\htranexe\" or TargetProcessName endswith \"\\\\lcxexe\") or (TargetProcessCommandLine contains \"exe -tran \" or TargetProcessCommandLine contains \"exe -slave \"))|extend RuleId=\"f5e3b62f-e577-4e59-931e-0a15b2b94e1e\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_htran_or_natbypass.yml\";\nlet q11=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"-u \" and TargetProcessCommandLine contains \"-p \") and (TargetProcessCommandLine contains \"^USER^\" or TargetProcessCommandLine contains \"^PASS^\"))|extend RuleId=\"aaafa146-074c-11eb-adc1-0242ac120002\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_hydra.yml\";\nlet q12=_Im_ProcessCreate\n| where (((ActingProcessName endswith \"\\\\wmiprvseexe\" or ActingProcessName endswith \"\\\\mmcexe\" or ActingProcessName endswith \"\\\\explorerexe\" or ActingProcessName endswith \"\\\\servicesexe\") and (TargetProcessCommandLine contains \"cmdexe\" and TargetProcessCommandLine contains \"/Q\" and TargetProcessCommandLine contains \"/c\" and TargetProcessCommandLine contains \"\\\\\\\\127001\\\\\" and TargetProcessCommandLine contains \"&1\")) or ((ActingProcessCommandLine contains \"svchostexe -k netsvcs\" or ActingProcessCommandLine contains \"taskengexe\") and (TargetProcessCommandLine contains \"cmdexe\" and TargetProcessCommandLine contains \"/C\" and TargetProcessCommandLine contains \"Windows\\\\Temp\\\\\" and TargetProcessCommandLine contains \"&1\")))|extend RuleId=\"10c14723-61c7-4c75-92ca-9af245723ad2\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_impacket_lateral_movement.yml\";\nlet q13=_Im_ProcessCreate\n| where ((TargetProcessName contains \"\\\\goldenPac\" or TargetProcessName contains \"\\\\karmaSMB\" or TargetProcessName contains \"\\\\kintercept\" or TargetProcessName contains \"\\\\ntlmrelayx\" or TargetProcessName contains \"\\\\rpcdump\" or TargetProcessName contains \"\\\\samrdump\" or TargetProcessName contains \"\\\\secretsdump\" or TargetProcessName contains \"\\\\smbexec\" or TargetProcessName contains \"\\\\smbrelayx\" or TargetProcessName contains \"\\\\wmiexec\" or TargetProcessName contains \"\\\\wmipersist\") or (TargetProcessName endswith \"\\\\atexec_windowsexe\" or TargetProcessName endswith \"\\\\dcomexec_windowsexe\" or TargetProcessName endswith \"\\\\dpapi_windowsexe\" or TargetProcessName endswith \"\\\\findDelegation_windowsexe\" or TargetProcessName endswith \"\\\\GetADUsers_windowsexe\" or TargetProcessName endswith \"\\\\GetNPUsers_windowsexe\" or TargetProcessName endswith \"\\\\getPac_windowsexe\" or TargetProcessName endswith \"\\\\getST_windowsexe\" or TargetProcessName endswith \"\\\\getTGT_windowsexe\" or TargetProcessName endswith \"\\\\GetUserSPNs_windowsexe\" or TargetProcessName endswith \"\\\\ifmap_windowsexe\" or TargetProcessName endswith \"\\\\mimikatz_windowsexe\" or TargetProcessName endswith \"\\\\netview_windowsexe\" or TargetProcessName endswith \"\\\\nmapAnswerMachine_windowsexe\" or TargetProcessName endswith \"\\\\opdump_windowsexe\" or TargetProcessName endswith \"\\\\psexec_windowsexe\" or TargetProcessName endswith \"\\\\rdp_check_windowsexe\" or TargetProcessName endswith \"\\\\sambaPipe_windowsexe\" or TargetProcessName endswith \"\\\\smbclient_windowsexe\" or TargetProcessName endswith \"\\\\smbserver_windowsexe\" or TargetProcessName endswith \"\\\\sniffer_windowsexe\" or TargetProcessName endswith \"\\\\sniff_windowsexe\" or TargetProcessName endswith \"\\\\split_windowsexe\" or TargetProcessName endswith \"\\\\ticketer_windowsexe\"))|extend RuleId=\"4627c6ae-6899-46e2-aa0c-6ebcb1becd19\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_impacket_tools.yml\";\nlet q14=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"cmd\" and TargetProcessCommandLine contains \"&&\" and TargetProcessCommandLine contains \"clipboard]::\" and TargetProcessCommandLine contains \"-f\") and (TargetProcessCommandLine contains \"/c\" or TargetProcessCommandLine contains \"/r\"))|extend RuleId=\"b222df08-0e07-11eb-adc1-0242ac120002\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_invoke_obfuscation_clip.yml\";\nlet q15=_Im_ProcessCreate\n| where (TargetProcessCommandLine matches regex \"\\\\$PSHome\\\\[\\\\s*\\\\d{1,3}\\\\s*\\\\]\\\\s*\\\\+\\\\s*\\\\$PSHome\\\\[\" or TargetProcessCommandLine matches regex \"\\\\$ShellId\\\\[\\\\s*\\\\d{1,3}\\\\s*\\\\]\\\\s*\\\\+\\\\s*\\\\$ShellId\\\\[\" or TargetProcessCommandLine matches regex \"\\\\$env:Public\\\\[\\\\s*\\\\d{1,3}\\\\s*\\\\]\\\\s*\\\\+\\\\s*\\\\$env:Public\\\\[\" or TargetProcessCommandLine matches regex \"\\\\$env:ComSpec\\\\[(\\\\s*\\\\d{1,3}\\\\s*,){2}\" or TargetProcessCommandLine matches regex \"\\\\*mdr\\\\*\\\\W\\\\s*\\\\)\\\\.Name\" or TargetProcessCommandLine matches regex \"\\\\$VerbosePreference\\\\.ToString\\\\(\" or TargetProcessCommandLine matches regex \"\\\\[String\\\\]\\\\s*\\\\$VerbosePreference\")|extend RuleId=\"4bf943c6-5146-4273-98dd-e958fd1e3abf\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_invoke_obfuscation_obfuscated_iex_commandline.yml\";\nlet q16=_Im_ProcessCreate\n| where (((TargetProcessCommandLine contains \"cmd\" and TargetProcessCommandLine contains \"powershell\") and (TargetProcessCommandLine contains \"/c\" or TargetProcessCommandLine contains \"/r\")) and (TargetProcessCommandLine contains \"noexit\" or (TargetProcessCommandLine contains \"input\" and TargetProcessCommandLine contains \"$\")))|extend RuleId=\"6c96fc76-0eb1-11eb-adc1-0242ac120002\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_invoke_obfuscation_stdin.yml\";\nlet q17=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"cmd\" and TargetProcessCommandLine contains \"\\\"set\" and TargetProcessCommandLine contains \"-f\") and (TargetProcessCommandLine contains \"/c\" or TargetProcessCommandLine contains \"/r\"))|extend RuleId=\"27aec9c9-dbb0-4939-8422-1742242471d0\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hktl_invoke_obfuscation_var.yml\";\nunion q0, q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11, q12, q13, q14, q15, q16, q17;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["CommandAndControl", "DefenseEvasion", "Discovery", "Collection", "Persistence", "Execution", "LateralMovement", "ResourceDevelopment", "PrivilegeEscalation", "CredentialAccess"],
                "techniques": ["T1027", "T1201", "T1090", "T1557", "T1059", "T1003", "T1110", "T1047", "T1053", "T1021", "T1588"],
                "alertRuleTemplateName": "5163A000-5160-5160-5160-5163A0000205",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}