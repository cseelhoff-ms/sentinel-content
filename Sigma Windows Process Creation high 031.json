{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-4c76-45a9-804d-dc3f355f2031')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-4c76-45a9-804d-dc3f355f2031')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 031",
                "description": "Sigma Windows Process Creation high 031",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((((TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessName endswith \"\\\\wmic.exe\" or TargetProcessName endswith \"\\\\vssadmin.exe\" or TargetProcessName endswith \"\\\\diskshadow.exe\") or (TargetProcessFilename =~ \"PowerShell.EXE\" or TargetProcessFilename =~ \"pwsh.dll\" or TargetProcessFilename =~ \"wmic.exe\" or TargetProcessFilename =~ \"VSSADMIN.EXE\" or TargetProcessFilename =~ \"diskshadow.exe\")) and (TargetProcessCommandLine contains \"shadow\" and TargetProcessCommandLine contains \"delete\")) or ((TargetProcessName endswith \"\\\\wbadmin.exe\" or TargetProcessFilename =~ \"WBADMIN.EXE\") and (TargetProcessCommandLine contains \"delete\" and TargetProcessCommandLine contains \"catalog\" and TargetProcessCommandLine contains \"quiet\")) or ((TargetProcessName endswith \"\\\\vssadmin.exe\" or TargetProcessFilename =~ \"VSSADMIN.EXE\") and ((TargetProcessCommandLine contains \"resize\" and TargetProcessCommandLine contains \"shadowstorage\") and (TargetProcessCommandLine contains \"unbounded\" or TargetProcessCommandLine contains \"/MaxSize=\"))))|extend RuleId=\"c947b146-0abc-4c87-9c64-b17e9d7274a2\";\nlet q1=_Im_ProcessCreate\n| where (((ActingProcessName endswith \"\\\\mshta.exe\" or ActingProcessName endswith \"\\\\powershell.exe\" or ActingProcessName endswith \"\\\\pwsh.exe\" or ActingProcessName endswith \"\\\\rundll32.exe\" or ActingProcessName endswith \"\\\\cscript.exe\" or ActingProcessName endswith \"\\\\wscript.exe\" or ActingProcessName endswith \"\\\\wmiprvse.exe\" or ActingProcessName endswith \"\\\\regsvr32.exe\") and (TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessName endswith \"\\\\nslookup.exe\" or TargetProcessName endswith \"\\\\certutil.exe\" or TargetProcessName endswith \"\\\\bitsadmin.exe\" or TargetProcessName endswith \"\\\\mshta.exe\")) and (not((TargetProcessCurrentDirectory contains \"\\\\ccmcache\\\\\" or (ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\setup-scheduledtask.ps1\" or ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\set-selfhealing.ps1\" or ActingProcessCommandLine contains \"\\\\Program Files\\\\Amazon\\\\WorkSpacesConfig\\\\Scripts\\\\check-workspacehealth.ps1\" or ActingProcessCommandLine contains \"\\\\nessus_\") or TargetProcessCommandLine contains \"\\\\nessus_\" or (ActingProcessName endswith \"\\\\mshta.exe\" and TargetProcessName endswith \"\\\\mshta.exe\" and (ActingProcessCommandLine contains \"C:\\\\MEM_Configmgr_\" and ActingProcessCommandLine contains \"\\\\splash.hta\" and ActingProcessCommandLine contains \"{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}\") and (TargetProcessCommandLine contains \"C:\\\\MEM_Configmgr_\" and TargetProcessCommandLine contains \"\\\\SMSSETUP\\\\BIN\\\\\" and TargetProcessCommandLine contains \"\\\\autorun.hta\" and TargetProcessCommandLine contains \"{1E460BD7-F1C3-4B2E-88BF-4E770A288AF5}\"))))))|extend RuleId=\"3a6586ad-127a-4d3b-a677-1e6eacdf8fde\";\nlet q2=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\svchost.exe\" or TargetProcessName endswith \"\\\\rundll32.exe\" or TargetProcessName endswith \"\\\\services.exe\" or TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\powershell_ise.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessName endswith \"\\\\regsvr32.exe\" or TargetProcessName endswith \"\\\\spoolsv.exe\" or TargetProcessName endswith \"\\\\lsass.exe\" or TargetProcessName endswith \"\\\\smss.exe\" or TargetProcessName endswith \"\\\\csrss.exe\" or TargetProcessName endswith \"\\\\conhost.exe\" or TargetProcessName endswith \"\\\\wininit.exe\" or TargetProcessName endswith \"\\\\lsm.exe\" or TargetProcessName endswith \"\\\\winlogon.exe\" or TargetProcessName endswith \"\\\\explorer.exe\" or TargetProcessName endswith \"\\\\taskhost.exe\" or TargetProcessName endswith \"\\\\Taskmgr.exe\" or TargetProcessName endswith \"\\\\sihost.exe\" or TargetProcessName endswith \"\\\\RuntimeBroker.exe\" or TargetProcessName endswith \"\\\\smartscreen.exe\" or TargetProcessName endswith \"\\\\dllhost.exe\" or TargetProcessName endswith \"\\\\audiodg.exe\" or TargetProcessName endswith \"\\\\wlanext.exe\" or TargetProcessName endswith \"\\\\dashost.exe\" or TargetProcessName endswith \"\\\\schtasks.exe\" or TargetProcessName endswith \"\\\\cscript.exe\" or TargetProcessName endswith \"\\\\wscript.exe\" or TargetProcessName endswith \"\\\\wsl.exe\" or TargetProcessName endswith \"\\\\bitsadmin.exe\" or TargetProcessName endswith \"\\\\atbroker.exe\" or TargetProcessName endswith \"\\\\bcdedit.exe\" or TargetProcessName endswith \"\\\\certutil.exe\" or TargetProcessName endswith \"\\\\certreq.exe\" or TargetProcessName endswith \"\\\\cmstp.exe\" or TargetProcessName endswith \"\\\\consent.exe\" or TargetProcessName endswith \"\\\\defrag.exe\" or TargetProcessName endswith \"\\\\dism.exe\" or TargetProcessName endswith \"\\\\dllhst3g.exe\" or TargetProcessName endswith \"\\\\eventvwr.exe\" or TargetProcessName endswith \"\\\\msiexec.exe\" or TargetProcessName endswith \"\\\\runonce.exe\" or TargetProcessName endswith \"\\\\winver.exe\" or TargetProcessName endswith \"\\\\logonui.exe\" or TargetProcessName endswith \"\\\\userinit.exe\" or TargetProcessName endswith \"\\\\dwm.exe\" or TargetProcessName endswith \"\\\\LsaIso.exe\" or TargetProcessName endswith \"\\\\ntoskrnl.exe\" or TargetProcessName endswith \"\\\\wsmprovhost.exe\" or TargetProcessName endswith \"\\\\dfrgui.exe\") and (not((((TargetProcessName startswith \"C:\\\\Windows\\\\System32\\\\\" or TargetProcessName startswith \"C:\\\\Windows\\\\SysWOW64\\\\\" or TargetProcessName startswith \"C:\\\\Windows\\\\WinSxS\\\\\") or TargetProcessName contains \"\\\\SystemRoot\\\\System32\\\\\" or (TargetProcessName =~ \"C:\\\\Windows\\\\explorer.exe\" or TargetProcessName =~ \"C:\\\\Program Files\\\\PowerShell\\\\7\\\\pwsh.exe\" or TargetProcessName =~ \"C:\\\\Program Files\\\\PowerShell\\\\7-preview\\\\pwsh.exe\")) or (TargetProcessName startswith \"C:\\\\Program Files\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux\" and TargetProcessName endswith \"\\\\wsl.exe\")))))|extend RuleId=\"e4a6b256-3e47-40fc-89d2-7a477edd6915\";\nlet q3=_Im_ProcessCreate\n| where (((TargetProcessIntegrityLevel =~ \"System\" and (TargetUsername contains \"AUTHORI\" or TargetUsername contains \"AUTORI\")) and ((TargetProcessName endswith \"\\\\calc.exe\" or TargetProcessName endswith \"\\\\wscript.exe\" or TargetProcessName endswith \"\\\\cscript.exe\" or TargetProcessName endswith \"\\\\hh.exe\" or TargetProcessName endswith \"\\\\mshta.exe\" or TargetProcessName endswith \"\\\\forfiles.exe\" or TargetProcessName endswith \"\\\\ping.exe\") or (TargetProcessCommandLine contains \" -NoP \" or TargetProcessCommandLine contains \" -W Hidden \" or TargetProcessCommandLine contains \" -decode \" or TargetProcessCommandLine contains \" /decode \" or TargetProcessCommandLine contains \" /urlcache \" or TargetProcessCommandLine contains \" -urlcache \" or TargetProcessCommandLine match \" -e JAB\" or TargetProcessCommandLine match \" -e SUVYI\" or TargetProcessCommandLine match \" -e SQBFAFgA\" or TargetProcessCommandLine match \" -e aWV4I\" or TargetProcessCommandLine match \" -e IAB\" or TargetProcessCommandLine match \" -e PAA\" or TargetProcessCommandLine match \" -e aQBlAHgA\" or TargetProcessCommandLine contains \"vssadmin delete shadows\" or TargetProcessCommandLine contains \"reg SAVE HKLM\" or TargetProcessCommandLine contains \" -ma \" or TargetProcessCommandLine contains \"Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\" or TargetProcessCommandLine contains \".downloadstring(\" or TargetProcessCommandLine contains \".downloadfile(\" or TargetProcessCommandLine contains \" /ticket:\" or TargetProcessCommandLine contains \"dpapi::\" or TargetProcessCommandLine contains \"event::clear\" or TargetProcessCommandLine contains \"event::drop\" or TargetProcessCommandLine contains \"id::modify\" or TargetProcessCommandLine contains \"kerberos::\" or TargetProcessCommandLine contains \"lsadump::\" or TargetProcessCommandLine contains \"misc::\" or TargetProcessCommandLine contains \"privilege::\" or TargetProcessCommandLine contains \"rpc::\" or TargetProcessCommandLine contains \"sekurlsa::\" or TargetProcessCommandLine contains \"sid::\" or TargetProcessCommandLine contains \"token::\" or TargetProcessCommandLine contains \"vault::cred\" or TargetProcessCommandLine contains \"vault::list\" or TargetProcessCommandLine contains \" p::d \" or TargetProcessCommandLine contains \";iex(\" or TargetProcessCommandLine contains \"MiniDump\" or TargetProcessCommandLine contains \"net user \"))) and (not((TargetProcessCommandLine =~ \"ping 127.0.0.1 -n 5\" or (TargetProcessName endswith \"\\\\PING.EXE\" and ActingProcessCommandLine contains \"\\\\DismFoDInstall.cmd\") or ActingProcessName startswith \"C:\\\\Packages\\\\Plugins\\\\Microsoft.GuestConfiguration.ConfigurationforWindows\\\\\" or (ActingProcessName startswith \"C:\\\\Program Files (x86)\\\\Java\\\\\" and ActingProcessName endswith \"\\\\bin\\\\javaws.exe\" and TargetProcessName startswith \"C:\\\\Program Files (x86)\\\\Java\\\\\" and TargetProcessName endswith \"\\\\bin\\\\jp2launcher.exe\" and TargetProcessCommandLine contains \" -ma \")))))|extend RuleId=\"2617e7ed-adb7-40ba-b0f3-8f9945fe6c09\";\nlet q4=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"echo \" or TargetProcessCommandLine contains \"copy \" or TargetProcessCommandLine contains \"type \" or TargetProcessCommandLine contains \"file createnew\") and (TargetProcessCommandLine contains \" C:\\\\Windows\\\\System32\\\\Tasks\\\\\" or TargetProcessCommandLine contains \" C:\\\\Windows\\\\SysWow64\\\\Tasks\\\\\"))|extend RuleId=\"cc4e02ba-9c06-48e2-b09e-2500cace9ae0\";\nlet q5=_Im_ProcessCreate\n| where TargetProcessCommandLine contains \".exe whoami\"|extend RuleId=\"e9142d84-fbe0-401d-ac50-3e519fb00c89\";\nlet q6=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\control.exe\" and ActingProcessName endswith \"\\\\WorkFolders.exe\") and (not(TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\control.exe\")))|extend RuleId=\"0bbc6369-43e3-453d-9944-cae58821c173\";\nlet q7=_Im_ProcessCreate\n| where ((TargetProcessCommandLine endswith \"svchost.exe\" and TargetProcessName endswith \"\\\\svchost.exe\") and (not(((ActingProcessName endswith \"\\\\rpcnet.exe\" or ActingProcessName endswith \"\\\\rpcnetp.exe\") or isnull(TargetProcessCommandLine)))))|extend RuleId=\"16c37b52-b141-42a5-a3ea-bbe098444397\";\nunion q0, q1, q2, q3, q4, q5, q6, q7;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Impact", "PrivilegeEscalation", "Discovery", "DefenseEvasion", "CredentialAccess", "Persistence", "Execution"],
                "techniques": ["T1218", "T1490", "T1070", "T1574", "T1033", "T1003", "T1059", "T1036", "T1134", "T1055", "T1027"],
                "alertRuleTemplateName": "5163A000-4c76-45a9-804d-dc3f355f2031",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}