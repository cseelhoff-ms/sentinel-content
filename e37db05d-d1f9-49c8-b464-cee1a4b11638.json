{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/e37db05d-d1f9-49c8-b464-cee1a4b11638')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e37db05d-d1f9-49c8-b464-cee1a4b11638')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "PUA - Rclone Execution",
                "description": "Detects execution of RClone utility for exfiltration as used by various ransomwares strains like REvil, Conti, FiveHands, etc\nSource URL: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_pua_rclone_execution.yml\nAuthor: Bhabesh Raj, Sittikorn S, Aaron Greetham (@beardofbinary) - NCC Group\nDate Modified: 2023-03-05\nStatus: experimental\nReferences: https://research.nccgroup.com/2021/05/27/detecting-rclone-an-effective-tool-for-exfiltration/, https://thedfirreport.com/2021/03/29/sodinokibi-aka-revil-ransomware, https://us-cert.cisa.gov/ncas/analysis-reports/ar21-126a, https://labs.sentinelone.com/egregor-raas-continues-the-chaos-with-cobalt-strike-and-rclone, https://www.splunk.com/en_us/blog/security/darkside-ransomware-splunk-threat-update-and-detections.html\nFalse Positives: Unknown",
                "severity": "high",
                "enabled": true,
                "query": "_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"--config \" and TargetProcessCommandLine contains \"--no-check-certificate \" and TargetProcessCommandLine contains \" copy \") or ((TargetProcessName endswith \"\\\\rclone.exe\" or TargetProcessFileDescription =~ \"Rsync for cloud storage\") and (TargetProcessCommandLine contains \"pass\" or TargetProcessCommandLine contains \"user\" or TargetProcessCommandLine contains \"copy\" or TargetProcessCommandLine contains \"sync\" or TargetProcessCommandLine contains \"config\" or TargetProcessCommandLine contains \"lsd\" or TargetProcessCommandLine contains \"remote\" or TargetProcessCommandLine contains \"ls\" or TargetProcessCommandLine contains \"mega\" or TargetProcessCommandLine contains \"pcloud\" or TargetProcessCommandLine contains \"ftp\" or TargetProcessCommandLine contains \"ignore-existing\" or TargetProcessCommandLine contains \"auto-confirm\" or TargetProcessCommandLine contains \"transfers\" or TargetProcessCommandLine contains \"multi-thread-streams\" or TargetProcessCommandLine contains \"no-check-certificate \")))",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["Exfiltration"],
                "techniques": ["T1567"],
                "alertRuleTemplateName": "e37db05d-d1f9-49c8-b464-cee1a4b11638",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}