{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-5160-5160-5160-5163A0000301')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-5160-5160-5160-5163A0000301')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 01",
                "description": "Sigma Windows Process Creation high 01",
                "severity": "high",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((ActingProcessName endswith \"\\\\sqlservr.exe\" and ActingProcessCommandLine contains \"VEEAMSQL\") and (((TargetProcessName endswith \"\\\\cmd.exe\" or TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessName endswith \"\\\\wsl.exe\" or TargetProcessName endswith \"\\\\wt.exe\") and (TargetProcessCommandLine contains \"-ex \" or TargetProcessCommandLine contains \"bypass\" or TargetProcessCommandLine contains \"cscript\" or TargetProcessCommandLine contains \"DownloadString\" or TargetProcessCommandLine contains \"http://\" or TargetProcessCommandLine contains \"https://\" or TargetProcessCommandLine contains \"mshta\" or TargetProcessCommandLine contains \"regsvr32\" or TargetProcessCommandLine contains \"rundll32\" or TargetProcessCommandLine contains \"wscript\" or TargetProcessCommandLine contains \"copy \")) or (TargetProcessName endswith \"\\\\net.exe\" or TargetProcessName endswith \"\\\\net1.exe\" or TargetProcessName endswith \"\\\\netstat.exe\" or TargetProcessName endswith \"\\\\nltest.exe\" or TargetProcessName endswith \"\\\\ping.exe\" or TargetProcessName endswith \"\\\\tasklist.exe\" or TargetProcessName endswith \"\\\\whoami.exe\")))|extend RuleId=\"d55b793d-f847-4eea-b59a-5ab09908ac90\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_mssql_veaam_susp_child_processes.yml\"|extend RuleTitle=\"Suspicious Child Process Of Veeam Dabatase\"|extend RuleDescription=\"Detects suspicious child processes of the Veeam service process. This could indicate potential RCE or SQL Injection.\";\nlet q1=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \"New-MailboxExportRequest\" and TargetProcessCommandLine contains \" -Mailbox \" and TargetProcessCommandLine contains \" -FilePath \\\\\\\\\")|extend RuleId=\"889719ef-dd62-43df-86c3-768fb08dc7c0\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_powershell_mailboxexport_share.yml\"|extend RuleTitle=\"Suspicious PowerShell Mailbox Export to Share\"|extend RuleDescription=\"Detects usage of the powerShell New-MailboxExportRequest Cmdlet to exports a mailbox to a remote or local share, as used in ProxyShell exploitations\";\nlet q2=_Im_ProcessCreate\n| where (TargetProcessFilename =~ \"whoami.exe\" and (not(TargetProcessName endswith \"\\\\whoami.exe\")))|extend RuleId=\"f1086bf7-a0c4-4a37-9102-01e573caf4a0\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_renamed_whoami.yml\"|extend RuleTitle=\"Renamed Whoami Execution\"|extend RuleDescription=\"Detects the execution of whoami that has been renamed to a different name to avoid detection\";\nlet q3=_Im_ProcessCreate\n| where ((TargetProcessName endswith \".doc.exe\" or TargetProcessName endswith \".docx.exe\" or TargetProcessName endswith \".xls.exe\" or TargetProcessName endswith \".xlsx.exe\" or TargetProcessName endswith \".ppt.exe\" or TargetProcessName endswith \".pptx.exe\" or TargetProcessName endswith \".rtf.exe\" or TargetProcessName endswith \".pdf.exe\" or TargetProcessName endswith \".txt.exe\" or TargetProcessName endswith \"      .exe\" or TargetProcessName endswith \"______.exe\" or TargetProcessName endswith \".doc.js\" or TargetProcessName endswith \".docx.js\" or TargetProcessName endswith \".xls.js\" or TargetProcessName endswith \".xlsx.js\" or TargetProcessName endswith \".ppt.js\" or TargetProcessName endswith \".pptx.js\" or TargetProcessName endswith \".rtf.js\" or TargetProcessName endswith \".pdf.js\" or TargetProcessName endswith \".txt.js\") and (TargetProcessCommandLine contains \".doc.exe\" or TargetProcessCommandLine contains \".docx.exe\" or TargetProcessCommandLine contains \".xls.exe\" or TargetProcessCommandLine contains \".xlsx.exe\" or TargetProcessCommandLine contains \".ppt.exe\" or TargetProcessCommandLine contains \".pptx.exe\" or TargetProcessCommandLine contains \".rtf.exe\" or TargetProcessCommandLine contains \".pdf.exe\" or TargetProcessCommandLine contains \".txt.exe\" or TargetProcessCommandLine contains \"      .exe\" or TargetProcessCommandLine contains \"______.exe\" or TargetProcessCommandLine contains \".doc.js\" or TargetProcessCommandLine contains \".docx.js\" or TargetProcessCommandLine contains \".xls.js\" or TargetProcessCommandLine contains \".xlsx.js\" or TargetProcessCommandLine contains \".ppt.js\" or TargetProcessCommandLine contains \".pptx.js\" or TargetProcessCommandLine contains \".rtf.js\" or TargetProcessCommandLine contains \".pdf.js\" or TargetProcessCommandLine contains \".txt.js\"))|extend RuleId=\"1cdd9a09-06c9-4769-99ff-626e2b3991b8\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_double_extension.yml\"|extend RuleTitle=\"Suspicious Double Extension File Execution\"|extend RuleDescription=\"Detects suspicious use of an .exe extension after a non-executable file extension like .pdf.exe, a set of spaces or underlines to cloak the executable file in spear phishing campaigns\";\nlet q4=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\DumpStack.log\" or TargetProcessCommandLine contains \" -o DumpStack.log\")|extend RuleId=\"4f647cfa-b598-4e12-ad69-c68dd16caef8\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_dumpstack_log_evasion.yml\"|extend RuleTitle=\"DumpStack.log Defender Evasion\"|extend RuleDescription=\"Detects the use of the filename DumpStack.log to evade Microsoft Defender\";\nlet q5=_Im_ProcessCreate\n| where TargetProcessName contains \"C:\\\\Windows \\\\System32\\\\\"|extend RuleId=\"4ac47ed3-44c2-4b1f-9d51-bf46e8914126\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_uac_bypass_trustedpath.yml\"|extend RuleTitle=\"TrustedPath UAC Bypass Pattern\"|extend RuleDescription=\"Detects indicators of a UAC bypass method by mocking directories\";\nlet q6=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\EdgeTransport.exe\" and (not((TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\conhost.exe\" or (TargetProcessName startswith \"C:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\\" and TargetProcessName endswith \"\\\\Bin\\\\OleConverter.exe\")))))|extend RuleId=\"797011dc-44f4-4e6f-9f10-a8ceefbe566b\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_wmi_backdoor_exchange_transport_agent.yml\"|extend RuleTitle=\"WMI Backdoor Exchange Transport Agent\"|extend RuleDescription=\"Detects a WMI backdoor in Exchange Transport Agents via WMI event filters\";\nunion q0, q1, q2, q3, q4, q5, q6;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["DefenseEvasion", "InitialAccess", "Exfiltration", "Persistence", "Discovery", "PrivilegeEscalation"],
                "techniques": ["T1566", "T1548", "T1033", "T1546"],
                "alertRuleTemplateName": "5163A000-5160-5160-5160-5163A0000301",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },                
                "alertDetailsOverride": {
                    "alertDisplayNameFormat": "{{RuleTitle}} ",
                    "alertDescriptionFormat": "{{RuleDescription}} ",
                    "alertDynamicProperties": [
                        {
                            "alertProperty": "ExtendedLinks",
                            "value": "SourceURL"
                        },
                        {
                            "alertProperty": "ProductComponentName",
                            "value": "RuleId"
                        }
                    ]
                },
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}