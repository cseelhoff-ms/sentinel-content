{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-5160-5160-5160-5163A0000301')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-5160-5160-5160-5163A0000301')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation critical 01",
                "description": "Sigma Windows Process Creation high 01",
                "severity": "high",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessName endswith \".doc.exe\" or TargetProcessName endswith \".docx.exe\" or TargetProcessName endswith \".xls.exe\" or TargetProcessName endswith \".xlsx.exe\" or TargetProcessName endswith \".ppt.exe\" or TargetProcessName endswith \".pptx.exe\" or TargetProcessName endswith \".rtf.exe\" or TargetProcessName endswith \".pdf.exe\" or TargetProcessName endswith \".txt.exe\" or TargetProcessName endswith \"      .exe\" or TargetProcessName endswith \"______.exe\" or TargetProcessName endswith \".doc.js\" or TargetProcessName endswith \".docx.js\" or TargetProcessName endswith \".xls.js\" or TargetProcessName endswith \".xlsx.js\" or TargetProcessName endswith \".ppt.js\" or TargetProcessName endswith \".pptx.js\" or TargetProcessName endswith \".rtf.js\" or TargetProcessName endswith \".pdf.js\" or TargetProcessName endswith \".txt.js\") and (TargetProcessCommandLine contains \".doc.exe\" or TargetProcessCommandLine contains \".docx.exe\" or TargetProcessCommandLine contains \".xls.exe\" or TargetProcessCommandLine contains \".xlsx.exe\" or TargetProcessCommandLine contains \".ppt.exe\" or TargetProcessCommandLine contains \".pptx.exe\" or TargetProcessCommandLine contains \".rtf.exe\" or TargetProcessCommandLine contains \".pdf.exe\" or TargetProcessCommandLine contains \".txt.exe\" or TargetProcessCommandLine contains \"      .exe\" or TargetProcessCommandLine contains \"______.exe\" or TargetProcessCommandLine contains \".doc.js\" or TargetProcessCommandLine contains \".docx.js\" or TargetProcessCommandLine contains \".xls.js\" or TargetProcessCommandLine contains \".xlsx.js\" or TargetProcessCommandLine contains \".ppt.js\" or TargetProcessCommandLine contains \".pptx.js\" or TargetProcessCommandLine contains \".rtf.js\" or TargetProcessCommandLine contains \".pdf.js\" or TargetProcessCommandLine contains \".txt.js\"))|extend RuleId=\"5163A000-5160-5160-5160-5163A0000300\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_double_extension.yml\";\nlet q1=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\DumpStack.log\" or TargetProcessCommandLine contains \" -o DumpStack.log\")|extend RuleId=\"4f647cfa-b598-4e12-ad69-c68dd16caef8\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_dumpstack_log_evasion.yml\";\nlet q2=_Im_ProcessCreate\n| where TargetProcessName contains \"C:\\\\Windows \\\\System32\\\\\"|extend RuleId=\"4ac47ed3-44c2-4b1f-9d51-bf46e8914126\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_uac_bypass_trustedpath.yml\";\nlet q3=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\EdgeTransport.exe\" and (not((TargetProcessName =~ \"C:\\\\Windows\\\\System32\\\\conhost.exe\" or (TargetProcessName startswith \"C:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\\" and TargetProcessName endswith \"\\\\Bin\\\\OleConverter.exe\")))))|extend RuleId=\"797011dc-44f4-4e6f-9f10-a8ceefbe566b\"|extend SourceURL=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_wmi_backdoor_exchange_transport_agent.yml\";\nunion q0, q1, q2, q3;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["PrivilegeEscalation", "DefenseEvasion", "InitialAccess", "Persistence"],
                "techniques": ["T1566", "T1546", "T1548"],
                "alertRuleTemplateName": "5163A000-5160-5160-5160-5163A0000301",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}