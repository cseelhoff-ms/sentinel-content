{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/5163A000-4c76-45a9-804d-dc3f355f2009')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/5163A000-4c76-45a9-804d-dc3f355f2009')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2022-11-01-preview",
            "properties": {
                "displayName": "Sigma Windows Process Creation high 009",
                "description": "Sigma Windows Process Creation high 009",
                "severity": "medium",
                "enabled": false,
                "query": "let q0=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\format.com\" and TargetProcessCommandLine contains \"/fs:\") and (not((TargetProcessCommandLine contains \"/fs:FAT\" or TargetProcessCommandLine contains \"/fs:exFAT\" or TargetProcessCommandLine contains \"/fs:NTFS\" or TargetProcessCommandLine contains \"/fs:UDF\" or TargetProcessCommandLine contains \"/fs:ReFS\"))))|extend RuleId=\"9fb6b26e-7f9e-4517-a48b-8cac4a1b6c60\";\nlet q1=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\IEExec.exe\" or TargetProcessFilename =~ \"IEExec.exe\") and (TargetProcessCommandLine contains \"https://\" or TargetProcessCommandLine contains \"http://\"))|extend RuleId=\"9801abb8-e297-4dbf-9fbd-57dde0e830ad\";\nlet q2=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \" run run-cmd \" and (not((ActingProcessName endswith \"\\\\kavremover.exe\" or ActingProcessName endswith \"\\\\cleanapi.exe\"))))|extend RuleId=\"d047726b-c71c-4048-a99b-2e2f50dc107d\";\nlet q3=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\wscript.exe\" or TargetProcessFilename =~ \"wscript.exe\") and TargetProcessCommandLine contains \"manage-bde.wsf\") or (((ActingProcessName endswith \"\\\\cscript.exe\" or ActingProcessName endswith \"\\\\wscript.exe\") and ActingProcessCommandLine contains \"manage-bde.wsf\") and (not(TargetProcessName endswith \"\\\\cmd.exe\"))))|extend RuleId=\"c363385c-f75d-4753-a108-c1a8e28bdbda\";\nlet q4=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \" /INJECTRUNNING \" and (not(ActingProcessName =~ \"C:\\\\Windows\\\\System32\\\\AppVClient.exe\")))|extend RuleId=\"4f73421b-5a0b-4bbf-a892-5a7fb99bea66\";\nlet q5=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\mpiexec.exe\" or TargetProcessIMPHASH =~ \"d8b52ef6aaa3a81501bdfff9dbb96217\" or Hashes contains \"IMPHASH=d8b52ef6aaa3a81501bdfff9dbb96217\") and (TargetProcessCommandLine contains \" /n 1 \" or TargetProcessCommandLine contains \" -n 1 \"))|extend RuleId=\"729ce0ea-5d8f-4769-9762-e35de441586d\";\nlet q6=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\msdt.exe\" and TargetProcessCommandLine contains \"\\\\WINDOWS\\\\diagnostics\\\\index\\\\PCWDiagnostic.xml\") and (TargetProcessCommandLine contains \" -af \" or TargetProcessCommandLine contains \" /af \")) and (not(ActingProcessName endswith \"\\\\pcwrun.exe\")))|extend RuleId=\"9c8c7000-3065-44a8-a555-79bcba5d9955\";\nlet q7=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\OpenWith.exe\" and TargetProcessCommandLine contains \"/c\")|extend RuleId=\"cec8e918-30f7-4e2d-9bfa-a59cc97ae60f\";\nlet q8=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\pcwrun.exe\" and TargetProcessCommandLine contains \"../\")|extend RuleId=\"6004abd0-afa4-4557-ba90-49d172e0a299\";\nlet q9=_Im_ProcessCreate\n| where (TargetProcessName endswith \"\\\\PrintBrm.exe\" and (TargetProcessCommandLine contains \" -f\" and TargetProcessCommandLine contains \".zip\"))|extend RuleId=\"cafeeba3-01da-4ab4-b6c4-a31b1d9730c7\";\nlet q10=_Im_ProcessCreate\n| where ((not((TargetProcessName startswith \"C:\\\\Windows\\\\System32\\\\\" or TargetProcessName startswith \"C:\\\\Windows\\\\SysWOW64\\\\\"))) and (ActingProcessCommandLine contains \"cmd.exe /c\" and ActingProcessCommandLine contains \"RoamDiag.cmd\" and ActingProcessCommandLine contains \"-outputpath\"))|extend RuleId=\"b2ddd389-f676-4ac4-845a-e00781a48e5f\";\nlet q11=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\AccCheckConsole.exe\" or TargetProcessFilename =~ \"AccCheckConsole.exe\") and (TargetProcessCommandLine contains \" -window \" and TargetProcessCommandLine contains \".dll\"))|extend RuleId=\"0f6da907-5854-4be6-859a-e9958747b0aa\";\nlet q12=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"AtBroker.exe\" and TargetProcessCommandLine contains \"start\") and (not((TargetProcessCommandLine contains \"animations\" or TargetProcessCommandLine contains \"audiodescription\" or TargetProcessCommandLine contains \"caretbrowsing\" or TargetProcessCommandLine contains \"caretwidth\" or TargetProcessCommandLine contains \"colorfiltering\" or TargetProcessCommandLine contains \"cursorscheme\" or TargetProcessCommandLine contains \"filterkeys\" or TargetProcessCommandLine contains \"focusborderheight\" or TargetProcessCommandLine contains \"focusborderwidth\" or TargetProcessCommandLine contains \"highcontrast\" or TargetProcessCommandLine contains \"keyboardcues\" or TargetProcessCommandLine contains \"keyboardpref\" or TargetProcessCommandLine contains \"magnifierpane\" or TargetProcessCommandLine contains \"messageduration\" or TargetProcessCommandLine contains \"minimumhitradius\" or TargetProcessCommandLine contains \"mousekeys\" or TargetProcessCommandLine contains \"Narrator\" or TargetProcessCommandLine contains \"osk\" or TargetProcessCommandLine contains \"overlappedcontent\" or TargetProcessCommandLine contains \"showsounds\" or TargetProcessCommandLine contains \"soundsentry\" or TargetProcessCommandLine contains \"stickykeys\" or TargetProcessCommandLine contains \"togglekeys\" or TargetProcessCommandLine contains \"windowarranging\" or TargetProcessCommandLine contains \"windowtracking\" or TargetProcessCommandLine contains \"windowtrackingtimeout\" or TargetProcessCommandLine contains \"windowtrackingzorder\"))))|extend RuleId=\"f24bcaea-0cd1-11eb-adc1-0242ac120002\";\nlet q13=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\certreq.exe\" or TargetProcessFilename =~ \"CertReq.exe\") and (TargetProcessCommandLine contains \" -Post \" and TargetProcessCommandLine contains \" -config \" and TargetProcessCommandLine contains \" http\" and TargetProcessCommandLine contains \" C:\\\\windows\\\\win.ini \"))|extend RuleId=\"4480827a-9799-4232-b2c4-ccc6c4e9e12b\";\nlet q14=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \"grpconv.exe -o\" or TargetProcessCommandLine contains \"grpconv -o\")|extend RuleId=\"f14e169e-9978-4c69-acb3-1cff8200bc36\";\nlet q15=_Im_ProcessCreate\n| where ((TargetProcessCommandLine contains \"MpCmdRun.exe\" or TargetProcessFileDescription =~ \"Microsoft Malware Protection Command Line Utility\") and (TargetProcessCommandLine contains \"DownloadFile\" and TargetProcessCommandLine contains \"url\"))|extend RuleId=\"46123129-1024-423e-9fae-43af4a0fa9a5\";\nlet q16=_Im_ProcessCreate\n| where ActingProcessName endswith \"\\\\tttracer.exe\"|extend RuleId=\"0b4ae027-2a2d-4b93-8c7e-962caaba5b2a\";\nlet q17=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\vbc.exe\" and TargetProcessName endswith \"\\\\cvtres.exe\")|extend RuleId=\"7b10f171-7f04-47c7-9fa2-5be43c76e535\";\nlet q18=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\wuauclt.exe\" or TargetProcessFilename =~ \"wuauclt.exe\") and (TargetProcessCommandLine contains \"UpdateDeploymentProvider\" and TargetProcessCommandLine contains \".dll\" and TargetProcessCommandLine contains \"RunHandlerComServer\")) and (not((TargetProcessCommandLine contains \" /UpdateDeploymentProvider UpdateDeploymentProvider.dll \" or TargetProcessCommandLine contains \" wuaueng.dll \"))))|extend RuleId=\"af77cf95-c469-471c-b6a0-946c685c4798\";\nlet q19=_Im_ProcessCreate\n| where (TargetProcessCommandLine contains \"\\\\\\\\?\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy\" and (TargetProcessCommandLine contains \"\\\\NTDS.dit\" or TargetProcessCommandLine contains \"\\\\SYSTEM\" or TargetProcessCommandLine contains \"\\\\SECURITY\" or TargetProcessCommandLine contains \"C:\\\\tmp\\\\log\"))|extend RuleId=\"f57f8d16-1f39-4dcb-a604-6c73d9b54b3d\";\nlet q20=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\wscript.exe\" or TargetProcessName endswith \"\\\\cscript.exe\") and (TargetProcessCommandLine contains \"C:\\\\Users\\\\\" or TargetProcessCommandLine contains \"C:\\\\ProgramData\\\\\")) and (TargetProcessCommandLine contains \".jse\" or TargetProcessCommandLine contains \".vbe\" or TargetProcessCommandLine contains \".js\" or TargetProcessCommandLine contains \".vba\" or TargetProcessCommandLine contains \".vbs\") and (not(ActingProcessName contains \"\\\\winzip\")))|extend RuleId=\"cea72823-df4d-4567-950c-0b579eaf0846\";\nlet q21=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\svchost.exe\" and TargetProcessName endswith \"\\\\mmc.exe\" and TargetProcessCommandLine contains \"-Embedding\")|extend RuleId=\"f1f3bf22-deb2-418d-8cce-e1a45e46a5bd\";\nlet q22=_Im_ProcessCreate\n| where (ActingProcessName endswith \"\\\\mmc.exe\" and ((TargetProcessName endswith \"\\\\cmd.exe\" or TargetProcessName endswith \"\\\\powershell.exe\" or TargetProcessName endswith \"\\\\pwsh.exe\" or TargetProcessName endswith \"\\\\wscript.exe\" or TargetProcessName endswith \"\\\\cscript.exe\" or TargetProcessName endswith \"\\\\sh.exe\" or TargetProcessName endswith \"\\\\bash.exe\" or TargetProcessName endswith \"\\\\reg.exe\" or TargetProcessName endswith \"\\\\regsvr32.exe\") or TargetProcessName contains \"\\\\BITSADMIN\"))|extend RuleId=\"05a2ab7e-ce11-4b63-86db-ab32e763e11d\";\nlet q23=_Im_ProcessCreate\n| where (((TargetProcessName endswith \"\\\\mofcomp.exe\" or TargetProcessFilename =~ \"mofcomp.exe\") and ((ActingProcessName endswith \"\\\\cmd.exe\" or ActingProcessName endswith \"\\\\powershell.exe\" or ActingProcessName endswith \"\\\\pwsh.exe\" or ActingProcessName endswith \"\\\\wsl.exe\" or ActingProcessName endswith \"\\\\wscript.exe\" or ActingProcessName endswith \"\\\\cscript.exe\") or (TargetProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Temp\" or TargetProcessCommandLine contains \"\\\\Users\\\\Public\\\\\" or TargetProcessCommandLine contains \"\\\\WINDOWS\\\\Temp\\\\\" or TargetProcessCommandLine contains \"%temp%\" or TargetProcessCommandLine contains \"%tmp%\" or TargetProcessCommandLine contains \"%appdata%\"))) and (not((ActingProcessName =~ \"C:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe\" and TargetProcessCommandLine contains \"C:\\\\Windows\\\\TEMP\\\\\" and TargetProcessCommandLine endswith \".mof\"))) and (not((TargetProcessCommandLine contains \"C:\\\\Windows\\\\TEMP\\\\\" and TargetProcessCommandLine endswith \".mof\"))))|extend RuleId=\"1dd05363-104e-4b4a-b963-196a534b03a1\";\nlet q24=_Im_ProcessCreate\n| where ((TargetProcessName endswith \"\\\\MpCmdRun.exe\" or TargetProcessName endswith \"\\\\NisSrv.exe\") and (not((TargetProcessName startswith \"C:\\\\Program Files (x86)\\\\Windows Defender\\\\\" or TargetProcessName startswith \"C:\\\\Program Files\\\\Microsoft Security Client\\\\\" or TargetProcessName startswith \"C:\\\\Program Files\\\\Windows Defender\\\\\" or TargetProcessName startswith \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\\" or TargetProcessName startswith \"C:\\\\Windows\\\\WinSxS\\\\\"))))|extend RuleId=\"7002aa10-b8d4-47ae-b5ba-51ab07e228b9\";\nunion q0, q1, q2, q3, q4, q5, q6, q7, q8, q9, q10, q11, q12, q13, q14, q15, q16, q17, q18, q19, q20, q21, q22, q23, q24;",
                "queryFrequency": "P1D",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": ["PrivilegeEscalation", "Impact", "LateralMovement", "DefenseEvasion", "CommandAndControl", "CredentialAccess", "Persistence", "Execution"],
                "techniques": ["T1218", "T1490", "T1574", "T1127", "T1027", "T1216", "T1105", "T1003", "T1564", "T1059", "T1021", "T1547", "T1055"],
                "alertRuleTemplateName": "5163A000-4c76-45a9-804d-dc3f355f2009",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "ActorUsername"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Dvc"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "TargetProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "TargetProcessCommandLine"
                            },
                            {
                                "identifier": "ElevationToken",
                                "columnName": "TargetProcessTokenElevation"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "HashType"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "Hash"
                            }
                        ]
                    },
                    {
                        "entityType": "File",
                        "fieldMappings": [
                            {
                                "identifier": "Directory",
                                "columnName": "TargetProcessCurrentDirectory"
                            },
                            {
                                "identifier": "Name",
                                "columnName": "TargetProcessName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        }
    ]
}